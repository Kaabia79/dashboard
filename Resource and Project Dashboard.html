<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Resource Dashboard v3.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* HEADER */
        .header {
            background: #0052CC;
            padding: 20px 30px;
            border-radius: 8px 8px 0 0;
            margin: -20px -20px 20px -20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .logo {
            font-size: 42px;
            font-weight: 700;
            color: #FF5722;
        }
        
        .tagline {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .title {
            font-size: 24px;
            font-weight: 600;
            margin-left: 30px;
            padding-left: 30px;
            border-left: 2px solid rgba(255,255,255,0.3);
        }
        
        /* CONTROLS */
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #E8F4F8;
            border-radius: 8px;
            border-left: 4px solid #0052CC;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #0052CC;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #0052CC;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
            background: white;
        }
        
        button {
            background: #0052CC;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        
        button:hover { opacity: 0.9; }
        
        .btn-export { background: #00A8E8 !important; }
        .btn-view { background: #607D8B !important; padding: 8px 16px !important; font-size: 12px !important; }
        .btn-view.active { background: #00A8E8 !important; }
        
        .btn-action {
            padding: 3px 8px !important;
            font-size: 10px !important;
            margin-right: 4px;
        }
        
        .btn-edit { background: #78909C !important; }
        .btn-delete { background: #EF5350 !important; }
        .btn-add { background: #66BB6A !important; }
        
        /* UTILIZATION DASHBOARD */
        .utilization-dashboard {
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #E8F4F8 0%, #D4E9F7 100%);
            border-radius: 8px;
            border: 2px solid #0052CC;
        }
        
        .utilization-dashboard h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #0052CC;
            font-weight: 700;
        }
        
        .utilization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .utilization-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #0052CC;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .utilization-card.overallocated {
            border-left-color: #EF5350;
            background: #FFEBEE;
        }
        
        .utilization-card.nearfull {
            border-left-color: #FF9800;
            background: #FFF3E0;
        }
        
        .utilization-card.healthy {
            border-left-color: #66BB6A;
        }
        
        .utilization-card h4 {
            font-size: 14px;
            margin-bottom: 4px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .days-per-week {
            font-size: 11px;
            font-weight: 600;
            color: #0052CC;
            background: #E8F4F8;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .utilization-bar {
            height: 24px;
            background: #E0E0E0;
            border-radius: 12px;
            overflow: hidden;
            margin: 8px 0;
            position: relative;
        }
        
        .utilization-fill {
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }
        
        .utilization-fill.green { background: #66BB6A; }
        .utilization-fill.amber { background: #FF9800; }
        .utilization-fill.red { background: #EF5350; }
        
        .utilization-projects {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
        }
        
        .utilization-projects span {
            display: inline-block;
            margin-right: 8px;
            padding: 2px 6px;
            background: #E8F4F8;
            border-radius: 3px;
        }
        
        /* LEGEND */
        .legend {
            margin-bottom: 20px;
            padding: 15px;
            background: #E8F4F8;
            border-radius: 8px;
            border-left: 4px solid #00A8E8;
        }
        
        .legend h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #0052CC;
            font-weight: 600;
        }
        
        .legend-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }
        
        .legend-box {
            width: 30px;
            height: 18px;
            border-radius: 9px;
        }
        
        /* TIMELINE HEADER - SINGLE AT TOP */
        .timeline-header-wrapper {
            display: flex;
            margin-bottom: 15px;
            border: 2px solid #0052CC;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .header-spacer {
            width: 320px;
            background: #0052CC;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .header-timeline {
            flex: 1;
            min-width: 800px;
        }
        
        .months-header {
            display: flex;
            background: #0052CC;
            color: white;
            height: 40px;
        }
        
        .month-cell {
            border-right: 1px solid #003D99;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        
        .weeks-header {
            display: flex;
            background: #E8F4F8;
            height: 30px;
        }
        
        .week-cell {
            border-right: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: #0052CC;
        }
        
        /* PROJECT ROW - UNIFIED BOX */
        .project-row {
            display: flex;
            border: 2px solid #E0E0E0;
            border-radius: 8px;
            margin-bottom: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            overflow: hidden;
            background: white;
        }
        
        .project-info {
            width: 320px;
            flex-shrink: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-self: stretch;
            border-right: 2px solid #E0E0E0;
        }
        
        .project-chart {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            min-width: 800px;
            position: relative;
        }
        
        /* PROJECT HEADER SECTION */
        .info-header {
            padding: 0;
            background: white;
        }
        
        .info-header-top {
            padding: 8px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .info-header-top:hover {
            background: #F5F5F5;
        }
        
        .info-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .collapse-arrow {
            font-size: 16px;
            color: #0052CC;
            font-weight: bold;
            width: 20px;
            text-align: center;
        }
        
        .project-name {
            font-weight: 700;
            font-size: 13px;
            color: #333;
            flex: 1;
        }
        
        .project-type-badge {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .type-won {
            background: #4CAF50;
            color: white;
        }
        
        .type-proposal {
            background: #9E9E9E;
            color: white;
        }
        
        .info-actions {
            display: flex;
            gap: 3px;
        }
        
        /* PROJECT DETAILS */
        .info-details {
            padding: 8px 10px;
            font-size: 11px;
            line-height: 1.4;
            border-top: 1px solid #E0E0E0;
            background: #FAFAFA;
        }
        
        .info-details.collapsed {
            display: none;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 3px;
        }
        
        .detail-label {
            font-weight: 600;
            color: #666;
            width: 90px;
            flex-shrink: 0;
        }
        
        .detail-value {
            color: #333;
            flex: 1;
        }
        
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 700;
        }
        
        .status-active { background: #4CAF50; color: white; }
        .status-completed { background: #2196F3; color: white; }
        .status-on-hold { background: #FF9800; color: white; }
        
        .health-on-track { color: #4CAF50; font-weight: 700; }
        .health-at-risk { color: #FF9800; font-weight: 700; }
        .health-delayed { color: #F44336; font-weight: 700; }
        
        .budget-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
        }
        
        .budget-green { background: #4CAF50; color: white; }
        .budget-amber { background: #FF9800; color: white; }
        .budget-red { background: #F44336; color: white; }
        
        /* RESOURCES SECTION */
        .info-resources {
            padding: 8px 10px;
            border-top: 1px solid #E0E0E0;
            flex: 1;
            overflow-y: auto;
        }
        
        .info-resources.collapsed {
            display: none;
        }
        
        .resources-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .resources-title {
            font-weight: 700;
            font-size: 11px;
            color: #0052CC;
        }
        
        .resource-item {
            padding: 5px;
            margin-bottom: 3px;
            background: #F9F9F9;
            border-radius: 4px;
            font-size: 10px;
            border-left: 3px solid #0052CC;
        }
        
        .resource-item.over-budget {
            border-left-color: #EF5350;
            border-left-width: 4px;
            background: #FFEBEE;
        }
        
        .resource-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        
        .resource-details {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 9px;
        }
        
        .resource-budget-info {
            font-size: 9px;
            margin-top: 2px;
            padding: 2px 4px;
            background: white;
            border-radius: 3px;
        }
        
        .resource-budget-info.over {
            background: #FFCDD2;
            color: #C62828;
            font-weight: 700;
        }
        
        .resource-budget-info.under {
            color: #2E7D32;
        }
        
        .resource-actions {
            display: flex;
            gap: 2px;
            margin-top: 3px;
        }
        
        /* CHART SECTION */
        .chart-project {
            height: 28px;
            display: flex;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #E0E0E0;
            position: relative;
        }
        
        .chart-grid {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .grid-cell {
            border-right: 1px solid #f0f0f0;
            position: relative;
        }
        
        .chart-bar {
            position: absolute;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 9px;
            font-weight: 600;
            color: white;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .progress-overlay {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px 0 0 10px;
            pointer-events: none;
        }
        
        .chart-resources {
            display: flex;
            flex-direction: column;
            padding: 4px 0;
        }
        
        /* Chart resources always visible - no collapsed state */
        
        .chart-resource {
            display: flex;
            align-items: center;
            height: 20px;
            margin-bottom: 2px;
            position: relative;
        }
        
        .resource-bar {
            position: absolute;
            height: 14px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            padding: 0 6px;
            font-size: 8px;
            font-weight: 600;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            overflow: visible;
            white-space: nowrap;
        }
        
        .resource-bar.over-budget {
            border: 3px solid #EF5350;
        }
        
        .resource-bar-label {
            position: relative;
            z-index: 10;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .resource-allocation-overlay {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 7px 0 0 7px;
            pointer-events: none;
        }
        
        .resource-highlight {
            background: #FFF9C4 !important;
            border: 2px solid #FFD700 !important;
        }
        
        /* ROLE COLORS */
        .role-pm { background: #1976D2; }
        .role-ba { background: #7B1FA2; }
        .role-tl { background: #00897B; }
        .role-pd { background: #C62828; }
        .role-cm { background: #EF6C00; }
        .role-other { background: #546E7A; }
        
        /* GRAYSCALE FOR PROPOSALS */
        .grayscale .role-pm { background: #757575; }
        .grayscale .role-ba { background: #9E9E9E; }
        .grayscale .role-tl { background: #757575; }
        .grayscale .role-pd { background: #616161; }
        .grayscale .role-cm { background: #757575; }
        .grayscale .role-other { background: #9E9E9E; }
        
        /* STATUS COLORS FOR WON PROJECTS */
        .status-on-track { background: #4CAF50; }
        .status-at-risk { background: #FF9800; }
        .status-delayed { background: #F44336; }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: #0052CC;
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #003D99;
        }
        
        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #0052CC;
        }
        
        .modal-header h2 {
            color: #0052CC;
            font-size: 22px;
        }
        
        .close {
            color: #999;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }
        
        .close:hover { color: #333; }
        
        .form-row {
            margin-bottom: 15px;
        }
        
        .form-row label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-row input,
        .form-row select,
        .form-row textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #E0E0E0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-row input:focus,
        .form-row select:focus,
        .form-row textarea:focus {
            outline: none;
            border-color: #0052CC;
        }
        
        .form-row textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-cancel {
            background: #757575 !important;
        }
        
        /* TAB NAVIGATION */
        .tab-navigation {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 3px solid #0052CC;
            background: #F5F7FA;
            padding: 10px 10px 0 10px;
            border-radius: 8px 8px 0 0;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: -3px;
        }
        
        .tab-button:hover {
            color: #0052CC;
            background: rgba(0, 82, 204, 0.05);
        }
        
        .tab-button.active {
            color: #0052CC;
            border-bottom-color: #0052CC;
            background: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* EXECUTIVE DASHBOARD STYLES */
        .exec-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .exec-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #0052CC;
        }
        
        .exec-card.warning {
            border-left-color: #FFA726;
        }
        
        .exec-card.danger {
            border-left-color: #EF5350;
        }
        
        .exec-card.success {
            border-left-color: #66BB6A;
        }
        
        .exec-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .exec-value {
            font-size: 32px;
            font-weight: 700;
            color: #0052CC;
            margin-bottom: 5px;
        }
        
        .exec-label {
            font-size: 12px;
            color: #999;
        }
        
        .risk-list {
            list-style: none;
            padding: 0;
        }
        
        .risk-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #FFF3E0;
            border-left: 3px solid #FF9800;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .risk-item.critical {
            background: #FFEBEE;
            border-left-color: #EF5350;
        }
        
        .action-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #E3F2FD;
            border-left: 3px solid #2196F3;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* RESOURCE CALENDAR STYLES */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #0052CC;
            color: white;
            border-radius: 8px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-nav button {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
        }
        
        .calendar-nav button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #E0E0E0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-day-header {
            background: #0052CC;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
        }
        
        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 8px;
            position: relative;
        }
        
        .calendar-day.other-month {
            background: #F5F5F5;
            opacity: 0.5;
        }
        
        .calendar-day.today {
            background: #FFF9C4;
            border: 2px solid #FFA726;
        }
        
        .day-number {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: #333;
        }
        
        .day-allocation {
            font-size: 10px;
            background: #E3F2FD;
            padding: 2px 6px;
            border-radius: 3px;
            margin-bottom: 4px;
            display: inline-block;
        }
        
        .day-allocation.over {
            background: #FFEBEE;
            color: #C62828;
            font-weight: 600;
        }
        
        .project-chip {
            font-size: 9px;
            padding: 3px 6px;
            border-radius: 3px;
            margin-bottom: 2px;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
            font-weight: 600;
        }
        
        .resource-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #E0E0E0;
        }
        
        .summary-card h4 {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: #0052CC;
        }
        
        /* AI FORECASTING STYLES */
        .ai-forecast-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .ai-forecast-card h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .ai-metric {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .ai-metric-box {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .ai-metric-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .ai-metric-value {
            font-size: 28px;
            font-weight: 700;
        }
        
        .ai-trend {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .ai-trend.up {
            background: #FFEBEE;
            color: #C62828;
        }
        
        .ai-trend.down {
            background: #E8F5E9;
            color: #2E7D32;
        }
        
        .ai-trend.neutral {
            background: #FFF3E0;
            color: #E65100;
        }
        
        .ai-recommendation {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #7E57C2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .ai-recommendation.high-priority {
            border-left-color: #EF5350;
        }
        
        .ai-recommendation.medium-priority {
            border-left-color: #FFA726;
        }
        
        .ai-recommendation.low-priority {
            border-left-color: #66BB6A;
        }
        
        .ai-recommendation h4 {
            margin: 0 0 10px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .priority-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-badge.high {
            background: #FFEBEE;
            color: #C62828;
        }
        
        .priority-badge.medium {
            background: #FFF3E0;
            color: #E65100;
        }
        
        .priority-badge.low {
            background: #E8F5E9;
            color: #2E7D32;
        }
        
        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .confidence-bar {
            flex: 1;
            height: 8px;
            background: #E0E0E0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #66BB6A 0%, #2E7D32 100%);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .forecast-timeline {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .timeline-chart {
            position: relative;
            height: 200px;
            margin-top: 20px;
        }
        
        .chart-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #E0E0E0;
            top: 50%;
        }
        
        .chart-point {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0052CC;
            transform: translate(-50%, -50%);
        }
        
        .chart-point.current {
            background: #2E7D32;
            width: 16px;
            height: 16px;
        }
        
        .chart-point.forecast {
            background: #EF5350;
        }
        
        /* RISK HEAT MAP STYLES */
        .risk-heat-map {
            display: grid;
            grid-template-columns: 80px repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .risk-axis-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #666;
            font-size: 13px;
        }
        
        .risk-cell {
            aspect-ratio: 1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }
        
        .risk-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .risk-cell.low-low {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-color: #66BB6A;
        }
        
        .risk-cell.low-medium,
        .risk-cell.medium-low {
            background: linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%);
            border-color: #FDD835;
        }
        
        .risk-cell.low-high,
        .risk-cell.medium-medium,
        .risk-cell.high-low {
            background: linear-gradient(135deg, #FFE0B2 0%, #FFCC80 100%);
            border-color: #FF9800;
        }
        
        .risk-cell.medium-high,
        .risk-cell.high-medium {
            background: linear-gradient(135deg, #FFCCBC 0%, #FF8A65 100%);
            border-color: #FF5722;
        }
        
        .risk-cell.high-high {
            background: linear-gradient(135deg, #FFCDD2 0%, #EF9A9A 100%);
            border-color: #EF5350;
        }
        
        .risk-project-chip {
            font-size: 10px;
            padding: 4px 8px;
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            margin: 2px;
            font-weight: 600;
            color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .scenario-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #E0E0E0;
            transition: all 0.3s;
        }
        
        .scenario-card:hover {
            border-color: #0052CC;
            box-shadow: 0 4px 12px rgba(0,82,204,0.1);
        }
        
        .scenario-card.recommended {
            border-color: #66BB6A;
            background: linear-gradient(135deg, #F1F8E9 0%, #FFFFFF 100%);
        }
        
        .scenario-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .scenario-badge.ai-recommended {
            background: #66BB6A;
            color: white;
        }
        
        .scenario-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .scenario-metric {
            text-align: center;
            padding: 15px;
            background: #F5F7FA;
            border-radius: 8px;
        }
        
        .scenario-metric-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .scenario-metric-value {
            font-size: 22px;
            font-weight: 700;
            color: #0052CC;
        }
        
        .scenario-comparison {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .comparison-arrow {
            font-size: 24px;
            color: #66BB6A;
        }
        
        .comparison-arrow.negative {
            color: #EF5350;
        }
        
        @media print {
            body { background: white; padding: 0; }
            .controls, button { display: none !important; }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div style="background: white; padding: 40px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 420px; width: 90%;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 48px; color: #0052CC; font-weight: 700;">ROHLING</div>
                <div style="color: #666; font-size: 14px; margin-top: 5px;">Portfolio Dashboard Access</div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Select Your Role</label>
                <select id="userRole" onchange="updatePasswordField()" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 8px; font-size: 14px;">
                    <option value="">-- Select Role --</option>
                    <option value="pm">Project Manager</option>
                    <option value="team">Team Member</option>
                    <option value="admin">Administrator</option>
                </select>
            </div>
            
            <div id="passwordField" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Access Code</label>
                <input type="password" id="accessCode" placeholder="Enter access code" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div id="teamMessage" style="display: none; margin-bottom: 20px; padding: 12px; background: #E8F5E9; border-left: 4px solid #4CAF50; border-radius: 4px;">
                <p style="margin: 0; color: #2E7D32; font-size: 13px; font-weight: 600;">Team Members: No password required - just click "Access Dashboard" below</p>
            </div>
            
            <button onclick="handleLogin()" style="width: 100%; padding: 14px; background: #0052CC; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                Access Dashboard
            </button>
            
            <div id="loginError" style="display: none; margin-top: 15px; padding: 12px; background: #FFEBEE; color: #C62828; border-radius: 8px; font-size: 13px; text-align: center;">
                Invalid access code. Please try again.
            </div>
            
            <div style="margin-top: 25px; padding-top: 25px; border-top: 1px solid #E0E0E0; font-size: 12px; color: #999; text-align: center;">
                <div style="margin-bottom: 8px; font-weight: 600; color: #666;">Access Codes:</div>

            </div>
        </div>
    </div>
    
    <div class="container" id="mainDashboard" style="display: none;">
        <div class="header">
            <div>
                <div class="logo">ROHLING</div>
                <div class="tagline">Professional Services Excellence</div>
            </div>
            <div class="title">Portfolio Resource Dashboard v3.0</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="exportData()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px;">
                     Export Data
                </button>
                <button onclick="document.getElementById('importFileInput').click()" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px;">
                     Import Data
                </button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>
        
        <!-- TAB NAVIGATION -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('portfolio')">
                 Portfolio View
            </button>
            <button class="tab-button" onclick="switchTab('calendar')">
                 Resource Calendar
            </button>
            <button class="tab-button" onclick="switchTab('executive')">
                 Executive Summary
            </button>
            <button class="tab-button" onclick="switchTab('resourceforecast')">
                 Resource Forecast
            </button>
            <button class="tab-button" onclick="switchTab('resourceavailability')">
                 Resource Availability
            </button>

            <button class="tab-button" onclick="switchTab('whatif')">
                 What-If Scenarios
            </button>
        </div>
        
        <!-- PORTFOLIO VIEW TAB -->
        <div id="portfolioTab" class="tab-content active">
        
        <div class="controls">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="addProject()">+ Add Project</button>
                <button onclick="exportData()" class="btn-export">Export Data</button>
                <button onclick="document.getElementById('importFileInput').click()" class="btn-export">Import Data</button>
                <button onclick="exportToPDF()" class="btn-export">Export PDF</button>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <div class="filter-group">
                    <label>Project:</label>
                    <select id="projectFilter" onchange="filterByProject()">
                        <option value="">All Projects</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Resource:</label>
                    <select id="resourceFilter" onchange="applyFilters()">
                        <option value="">All Resources</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>From:</label>
                    <input type="date" id="dateFrom" onchange="applyFilters()" style="padding: 8px; border: 2px solid #0052CC; border-radius: 6px; font-size: 14px;">
                </div>
                
                <div class="filter-group">
                    <label>To:</label>
                    <input type="date" id="dateTo" onchange="applyFilters()" style="padding: 8px; border: 2px solid #0052CC; border-radius: 6px; font-size: 14px;">
                </div>
                
                <button onclick="clearFilters()" style="background: #757575 !important; padding: 8px 16px !important; font-size: 12px !important;">Clear Filters</button>
                
                <button id="btnWeekly" class="btn-view" onclick="changeView('weekly')">Weekly</button>
                <button id="btnBiweekly" class="btn-view" onclick="changeView('biweekly')">Bi-Weekly</button>
                <button id="btnMonthly" class="btn-view active" onclick="changeView('monthly')">Monthly</button>
                <button id="btnQuarterly" class="btn-view" onclick="changeView('quarterly')">Quarterly</button>
            </div>
        </div>
        
        <!-- Resource Utilization Dashboard -->
        <div class="utilization-dashboard" id="utilizationDashboard">
            <h3> Resource Utilization Overview</h3>
            <div class="utilization-grid" id="utilizationGrid"></div>
        </div>
        
        <div class="legend">
            <h3>Role Legend</h3>
            <div class="legend-items">
                <div class="legend-item"><div class="legend-box role-pm"></div> Project Manager</div>
                <div class="legend-item"><div class="legend-box role-ba"></div> Business Analyst</div>
                <div class="legend-item"><div class="legend-box role-tl"></div> Tech Lead</div>
                <div class="legend-item"><div class="legend-box role-pd"></div> Project Director</div>
                <div class="legend-item"><div class="legend-box role-cm"></div> Change Manager</div>
                <div class="legend-item"><div class="legend-box role-other"></div> Other</div>
            </div>
        </div>
        
        <div id="timeline-header"></div>
        <div id="projects-container"></div>
    </div>
    
    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeProjectModal()">&times;</span>
                <h2>Project Details</h2>
            </div>
            <form id="projectForm">
                <div class="form-row">
                    <label>Project Name *</label>
                    <input type="text" id="projName" required>
                </div>
                <div class="form-row">
                    <label>Type *</label>
                    <select id="projType" required>
                        <option value="Won">Won</option>
                        <option value="Proposal">Proposal</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Status *</label>
                    <select id="projStatus" required>
                        <option value="Active">Active</option>
                        <option value="Completed">Completed</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Health Status *</label>
                    <select id="projHealth" required>
                        <option value="On Track">On Track</option>
                        <option value="At Risk">At Risk</option>
                        <option value="Delayed">Delayed</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Client *</label>
                    <input type="text" id="projClient" required>
                </div>
                <div class="form-row">
                    <label>Project Manager *</label>
                    <input type="text" id="projManager" required>
                </div>
                <div class="form-row">
                    <label>Budget ($) *</label>
                    <input type="number" id="projBudget" required>
                </div>
                <div class="form-row">
                    <label>Planned Effort (hours) *</label>
                    <input type="number" id="projEffortBudget" required>
                </div>
                <div class="form-row">
                    <label>Actual Effort (hours)</label>
                    <input type="number" id="projActualEffort" value="0">
                </div>
                <div class="form-row">
                    <label>Start Date *</label>
                    <input type="date" id="projStart" required>
                </div>
                <div class="form-row">
                    <label>End Date *</label>
                    <input type="date" id="projEnd" required>
                </div>
                <div class="form-row">
                    <label>Progress (%) *</label>
                    <input type="number" id="projProgress" min="0" max="100" required>
                </div>
                <div class="form-row">
                    <label>Updates / Notes</label>
                    <textarea id="projUpdates"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeProjectModal()">Cancel</button>
                    <button type="submit">Save Project</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Resource Modal -->
    <div id="resourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeResourceModal()">&times;</span>
                <h2>Resource Details</h2>
            </div>
            <form id="resourceForm">
                <div class="form-row">
                    <label>Name *</label>
                    <input type="text" id="resName" required>
                </div>
                <div class="form-row">
                    <label>Role *</label>
                    <select id="resRole" required>
                        <option value="Project Manager">Project Manager</option>
                        <option value="Business Analyst">Business Analyst</option>
                        <option value="Tech Lead">Tech Lead</option>
                        <option value="Project Director">Project Director</option>
                        <option value="Change Manager">Change Manager</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Planned Hours *</label>
                    <input type="number" id="resPlannedHours" required>
                </div>
                <div class="form-row">
                    <label>Actual Hours</label>
                    <input type="number" id="resActualHours" value="0">
                </div>
                <div class="form-row">
                    <label>Allocation (%) *</label>
                    <input type="number" id="resAllocation" min="0" max="100" required>
                </div>
                <div class="form-row">
                    <label>Start Date *</label>
                    <input type="date" id="resStart" required>
                </div>
                <div class="form-row">
                    <label>End Date *</label>
                    <input type="date" id="resEnd" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeResourceModal()">Cancel</button>
                    <button type="submit">Save Resource</button>
                </div>
            </form>
        </div>
    </div>
    
    </div> <!-- End Portfolio Tab -->
    
    <!-- RESOURCE CALENDAR TAB -->
    <div id="calendarTab" class="tab-content">
        <div class="calendar-header">
            <div>
                <h2 style="margin: 0;">Resource Calendar</h2>
            </div>
            <div class="calendar-nav">
                <button onclick="changeCalendarMonth(-1)"> Previous</button>
                <div style="text-align: center;">
                    <span id="calendarMonthYear" style="font-size: 18px; font-weight: 600; display: block;">November 2025</span>
                    <span id="calendarDateRange" style="font-size: 12px; color: #666; display: block; margin-top: 4px;"></span>
                </div>
                <button onclick="changeCalendarMonth(1)">Next </button>
            </div>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="margin-right: 5px; font-weight: 600;">Resource:</label>
                    <select id="calendarResourceSelect" onchange="renderCalendar()" style="padding: 8px; border-radius: 4px; border: 2px solid #0052CC; min-width: 200px;">
                        <option value="">Select Resource</option>
                    </select>
                </div>
                <div style="display: flex; gap: 5px; align-items: center; background: #E3F2FD; padding: 8px 12px; border-radius: 6px; border: 2px solid #0052CC;">
                    <label style="font-size: 12px; font-weight: 600; color: #0052CC;">Date Range:</label>
                    <input type="date" id="calendarStartDate" onchange="updateCalendarDateRange()" style="padding: 6px; border-radius: 4px; border: 1px solid #0052CC; font-size: 12px;">
                    <span style="font-weight: 600; color: #0052CC;">to</span>
                    <input type="date" id="calendarEndDate" onchange="updateCalendarDateRange()" style="padding: 6px; border-radius: 4px; border: 1px solid #0052CC; font-size: 12px;">
                    <button onclick="resetToCurrentMonth()" style="padding: 6px 12px; background: #0052CC; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">Current Month</button>
                </div>
                <button onclick="showAddLeaveModal()" style="background: #FF9800 !important;">+ Add Leave</button>
            </div>
        
        <!-- Resource Summary Section -->
        <div id="resourceSummarySection" style="display: none; margin: 20px 0; padding: 20px; background: white; border-radius: 8px; border: 2px solid #0052CC;">
            <h3 style="margin: 0 0 15px 0; color: #0052CC;"> Resource Summary</h3>
            <div id="resourceSummaryContent"></div>
        </div>
        
        <!-- PM Edit Hint -->
        <div id="pmEditHint" style="display: none; margin: 10px 0; padding: 12px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; font-size: 13px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
            <strong> Quick Edit Tip:</strong> Click any project chip in the calendar below to quickly adjust allocation percentages!
        </div>
        
        </div>
        
        <div class="resource-summary" id="resourceSummary"></div>
        
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>
    
    <!-- EXECUTIVE SUMMARY TAB -->
    <div id="executiveTab" class="tab-content">
        <h2 style="margin-bottom: 20px; color: #0052CC;"> Executive Dashboard</h2>
        
        <div class="exec-grid" id="execMetrics"></div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="exec-card danger">
                <h3> Critical Risks</h3>
                <ul class="risk-list" id="criticalRisks"></ul>
            </div>
            
            <div class="exec-card warning">
                <h3> Actions Required</h3>
                <div id="actionsRequired"></div>
            </div>
        </div>
        
        <div class="exec-card" style="margin-top: 20px;">
            <h3> Project Health Distribution</h3>
            <div id="healthChart" style="margin-top: 15px;"></div>
        </div>
    </div>
    
    <!-- AI FORECASTING TAB -->
    <div id="resourceforecastTab" class="tab-content">
        <h2 style="margin-bottom: 20px; color: #0052CC;"> Resource Forecast</h2>
        
        <div class="controls" style="margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
            <div>
                <label style="margin-right: 10px; font-weight: 600;">View:</label>
                <button class="btn-view active" onclick="setForecastView('monthly')">Monthly (6)</button>
                <button class="btn-view" onclick="setForecastView('quarterly')">Quarterly (4)</button>
                <button class="btn-view" onclick="setForecastView('sixmonth')">6 Months (2)</button>
                <button class="btn-view" onclick="setForecastView('custom')">Custom Range</button>
            </div>
            <div id="customDateRange" style="display: none; gap: 10px; align-items: center;">
                <label style="font-weight: 600;">From:</label>
                <input type="date" id="customStartDate" style="padding: 8px; border: 2px solid #0052CC; border-radius: 4px;">
                <label style="font-weight: 600;">To:</label>
                <input type="date" id="customEndDate" style="padding: 8px; border: 2px solid #0052CC; border-radius: 4px;">
                <button onclick="applyCustomRange()" style="padding: 8px 16px; background: #0052CC; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Apply</button>
            </div>
        </div>
        
        <div id="forecastGantt" style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #0052CC;">
            <div id="ganttTimeline"></div>
            <div id="ganttChart"></div>
        </div>
    </div>
    
    
    
    <div id="resourceavailabilityTab" class="tab-content">
        <h2 style="margin-bottom: 20px; color: #0052CC;"> Resource Availability by Role</h2>
        
        <div class="controls" style="margin-bottom: 20px;">
            <label style="margin-right: 10px; font-weight: 600;">Filter by Role:</label>
            <select id="roleFilter" onchange="renderResourceAvailability()" style="padding: 8px; border: 2px solid #0052CC; border-radius: 4px; font-size: 14px;">
                <option value="">All Roles</option>
                <option value="Project Manager">Project Manager</option>
                <option value="Business Analyst">Business Analyst</option>
                <option value="Tech Lead">Tech Lead</option>
                <option value="Change Manager">Change Manager</option>
                <option value="Project Director">Project Director</option>
                <option value="Other">Other</option>
            </select>
            
            <label style="margin: 0 10px 0 30px; font-weight: 600;">Time Period:</label>
            <select id="availabilityPeriod" onchange="renderResourceAvailability()" style="padding: 8px; border: 2px solid #0052CC; border-radius: 4px; font-size: 14px;">
                <option value="current">Current Month</option>
                <option value="next">Next Month</option>
                <option value="quarter">This Quarter</option>
            </select>
        </div>
        
        <div id="availabilityGrid" style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #0052CC;"></div>
    </div>
    
    <div id="whatifTab" class="tab-content">
        <h2 style="margin-bottom: 20px; color: #0052CC;"> AI What-If Scenario Planner</h2>
        
        <div style="margin-bottom: 20px;">
            <label style="font-weight: 600; margin-right: 10px;">Select Project:</label>
            <select id="scenarioProjectSelect" onchange="renderScenarios()" style="padding: 10px; border: 2px solid #0052CC; border-radius: 6px; font-size: 14px; min-width: 300px;">
                <option value="">-- Select a Project --</option>
            </select>
        </div>
        
        <div id="scenarioContent"></div>
    </div>
    
    <!-- ADD LEAVE MODAL -->
    <div id="leaveModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span class="close" onclick="closeLeaveModal()">&times;</span>
                <h2>Add Resource Leave</h2>
            </div>
            <form id="leaveForm">
                <div class="form-row">
                    <label>Resource</label>
                    <select id="leaveResource" required>
                        <option value="">Select Resource</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Leave Type</label>
                    <select id="leaveType">
                        <option value="Annual Leave">Annual Leave</option>
                        <option value="Sick Leave">Sick Leave</option>
                        <option value="Personal Leave">Personal Leave</option>
                        <option value="Long Service">Long Service Leave</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Start Date</label>
                    <input type="date" id="leaveStartDate" required>
                </div>
                <div class="form-row">
                    <label>End Date</label>
                    <input type="date" id="leaveEndDate" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeLeaveModal()">Cancel</button>
                    <button type="submit">Add Leave</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- EDIT RESOURCE ALLOCATION MODAL -->
    <div id="editAllocationModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <span class="close" onclick="closeEditAllocationModal()">&times;</span>
                <h2>Edit Resource Allocation</h2>
            </div>
            <div style="padding: 20px;">
                <div style="background: #E3F2FD; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #0052CC;">
                    <div style="font-weight: 600; font-size: 14px; color: #0052CC; margin-bottom: 4px;">
                        <span id="editResourceName"></span> - <span id="editProjectName"></span>
                    </div>
                    <div style="font-size: 12px; color: #555;">
                        Role: <span id="editResourceRole"></span>
                    </div>
                </div>
                
                <form id="editAllocationForm">
                    <div class="form-row">
                        <label>Planned Hours</label>
                        <input type="number" id="editPlannedHours" min="0" step="0.5" required style="width: 100%; padding: 10px; border: 2px solid #E0E0E0; border-radius: 6px;">
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">Total hours allocated for this project</div>
                    </div>
                    
                    <div class="form-row">
                        <label>Allocation Percentage</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="editAllocationSlider" min="0" max="100" step="5" value="100" 
                                   oninput="document.getElementById('editAllocationValue').textContent = this.value + '%'"
                                   style="flex: 1;">
                            <span id="editAllocationValue" style="font-weight: 700; font-size: 16px; color: #0052CC; min-width: 50px;">100%</span>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                            Daily hours: <span id="editDailyHours" style="font-weight: 600;">8.0h</span> (100% = 8 hours/day)
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label>Start Date</label>
                        <input type="date" id="editStartDate" required style="width: 100%; padding: 10px; border: 2px solid #E0E0E0; border-radius: 6px;">
                    </div>
                    
                    <div class="form-row">
                        <label>End Date</label>
                        <input type="date" id="editEndDate" required style="width: 100%; padding: 10px; border: 2px solid #E0E0E0; border-radius: 6px;">
                    </div>
                    
                    <div style="background: #FFF3E0; padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #FF9800;">
                        <div style="font-size: 12px; color: #E65100;">
                            <strong> Tip:</strong> Allocation percentage affects daily hours. Adjust based on resource availability across multiple projects.
                        </div>
                    </div>
                    
                    <div class="form-actions" style="margin-top: 20px;">
                        <button type="button" class="btn-cancel" onclick="closeEditAllocationModal()">Cancel</button>
                        <button type="button" id="fullSaveBtn" style="background: #0052CC; color: white; padding: 10px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;"> Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- EDIT DAY ALLOCATION MODAL -->
    <div id="editDayModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span class="close" onclick="closeEditDayModal()">&times;</span>
                <h2>Quick Edit - Day Allocation</h2>
            </div>
            <div style="padding: 20px;">
                <div style="background: #E8F5E9; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #4CAF50;">
                    <div style="font-weight: 600; font-size: 14px; color: #2E7D32; margin-bottom: 6px;">
                         <span id="dayEditDate"></span>
                    </div>
                    <div style="font-size: 13px; color: #555; margin-bottom: 3px;">
                        <strong>Resource:</strong> <span id="dayEditResourceName"></span>
                    </div>
                    <div style="font-size: 13px; color: #555;">
                        <strong>Project:</strong> <span id="dayEditProjectName"></span>
                    </div>
                </div>
                
                <div style="background: #FFF3E0; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #FF9800;">
                    <div style="font-size: 12px; color: #E65100; margin-bottom: 8px;">
                        <strong> Note:</strong> This adjusts the allocation percentage for this project, which affects ALL days in the project period.
                    </div>
                    <div style="font-size: 11px; color: #666;">
                        To edit specific dates, use the full allocation editor from the Resource Summary panel.
                    </div>
                </div>
                
                <form id="editDayForm">
                    <div class="form-row">
                        <label>Current Daily Hours: <span id="dayCurrentHours" style="font-weight: 700; color: #0052CC;"></span></label>
                        <div style="font-size: 11px; color: #666; margin-bottom: 10px;">Based on <span id="dayCurrentAllocation"></span>% allocation</div>
                    </div>
                    
                    <div class="form-row">
                        <label>New Allocation Percentage</label>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <input type="range" id="dayEditAllocationSlider" min="0" max="100" step="5" value="100" 
                                   oninput="updateDayAllocationDisplay()"
                                   style="flex: 1;">
                            <span id="dayEditAllocationValue" style="font-weight: 700; font-size: 18px; color: #0052CC; min-width: 50px;">100%</span>
                        </div>
                        <div style="background: #E3F2FD; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">New Daily Hours</div>
                            <div id="dayNewDailyHours" style="font-size: 24px; font-weight: 700; color: #0052CC;">8.0h</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; padding: 12px; background: #F5F5F5; border-radius: 6px; font-size: 12px;">
                        <div>
                            <div style="color: #666;">Project Period:</div>
                            <div style="font-weight: 600; color: #333; font-size: 11px;" id="dayProjectPeriod"></div>
                        </div>
                        <div>
                            <div style="color: #666;">Total Planned:</div>
                            <div style="font-weight: 600; color: #333;" id="dayTotalPlanned"></div>
                        </div>
                    </div>
                    
                    <div class="form-actions" style="margin-top: 20px;">
                        <button type="button" class="btn-cancel" onclick="closeEditDayModal()">Cancel</button>
                        <button type="button" id="quickSaveBtn" onclick="handleQuickSave()" style="background: #4CAF50; color: white; padding: 10px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;"> Quick Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // ===== ROLE-BASED ACCESS CONTROL =====
        let userRole = null;
        const ACCESS_CODES = {
            'pm': 'RhPM$2025@Secure',
            'team': 'RhTeam#2025&Access',
            'admin': 'RhAdmin!2025*Control'
        };
        
        function updatePasswordField() {
            const role = document.getElementById('userRole').value;
            const passwordField = document.getElementById('passwordField');
            const teamMessage = document.getElementById('teamMessage');
            
            if (role === 'team') {
                passwordField.style.display = 'none';
                teamMessage.style.display = 'block';
            } else {
                passwordField.style.display = 'block';
                teamMessage.style.display = 'none';
            }
        }
        
        function handleLogin() {
            const role = document.getElementById('userRole').value;
            const code = document.getElementById('accessCode').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!role) {
                errorDiv.textContent = 'Please select a role';
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 3000);
                return;
            }
            
            // Team members don't need password
            if (role === 'team') {
                userRole = role;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                applyRoleBasedAccess();
                initializeDashboard();
                return;
            }
            
            // PM and Admin need password
            if (ACCESS_CODES[role] === code) {
                userRole = role;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                applyRoleBasedAccess();
                initializeDashboard();
            } else {
                errorDiv.textContent = 'Invalid access code. Please try again.';
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 3000);
            }
        }
        
        function applyRoleBasedAccess() {
            const tabButtons = document.querySelectorAll('.tab-button');
            
            if (userRole === 'team') {
                // Team members: Only Resource Calendar visible
                tabButtons.forEach(btn => {
                    const btnText = btn.textContent.trim();
                    if (!btnText.includes('Resource Calendar')) {
                        btn.style.display = 'none';
                    }
                });
                // Auto-switch to calendar
                setTimeout(() => switchTab('calendar'), 100);
                
                // Hide edit/delete buttons
                hideEditControls();
                
            } else if (userRole === 'pm') {
                // Project Managers: All tabs visible, can edit their projects
                tabButtons.forEach(btn => btn.style.display = '');
                
                // Can edit but not access admin settings
                
            } else if (userRole === 'admin') {
                // Admins: Everything + admin controls
                tabButtons.forEach(btn => btn.style.display = '');
                
                // Show admin controls
                showAdminControls();
            }
        }
        
        function hideEditControls() {
            // Add CSS to hide edit/delete buttons for team members
            const style = document.createElement('style');
            style.id = 'team-restrictions';
            style.textContent = `
                .project-actions button:not([onclick*="render"]) { display: none !important; }
                button[onclick*="showAddProject"] { display: none !important; }
                button[onclick*="showAddResource"] { display: none !important; }
                button[onclick*="edit"] { display: none !important; }
                button[onclick*="delete"] { display: none !important; }
            `;
            document.head.appendChild(style);
        }
        
        function showAdminControls() {
            // Add admin indicator badge
            const header = document.querySelector('.header');
            if (header && !document.getElementById('adminBadge')) {
                const badge = document.createElement('div');
                badge.id = 'adminBadge';
                badge.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="background: #FF9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                             ADMIN MODE
                        </span>
                        <button onclick="showAdminPanel()" style="background: #7E57C2; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                             Settings
                        </button>
                    </div>
                `;
                header.appendChild(badge);
            }
        }
        
        function showAdminPanel() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                    <h2 style="margin: 0 0 20px 0; color: #0052CC;"> Admin Settings</h2>
                    
                    <!-- ACCESS CODE MANAGEMENT -->
                    <div style="background: #F5F7FA; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;"> Access Code Management</h3>
                        
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;">Project Manager Code:</label>
                                <input type="text" id="adminNewPMCode" value="${ACCESS_CODES.pm}" style="width: 100%; padding: 10px; border: 2px solid #E0E0E0; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;">Team Member Code:</label>
                                <input type="text" id="adminNewTeamCode" value="${ACCESS_CODES.team}" style="width: 100%; padding: 10px; border: 2px solid #E0E0E0; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;">Administrator Code:</label>
                                <input type="text" id="adminNewAdminCode" value="${ACCESS_CODES.admin}" style="width: 100%; padding: 10px; border: 2px solid #E0E0E0; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <button onclick="updateAccessCodes()" style="margin-top: 15px; width: 100%; padding: 12px; background: #0052CC; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            Update Access Codes
                        </button>
                        
                        <div style="margin-top: 10px; padding: 12px; background: #FFF3E0; border-radius: 6px; font-size: 12px; color: #E65100;">
                             Note: Code changes only apply to this session. To make permanent, update the HTML file.
                        </div>
                    </div>
                    
                    <!-- USER AUDIT LOG -->
                    <div style="background: #F5F7FA; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;"> Session Info</h3>
                        <div style="font-size: 13px; line-height: 1.8;">
                            <div><strong>Current Role:</strong> Administrator</div>
                            <div><strong>Login Time:</strong> ${new Date().toLocaleString()}</div>
                            <div><strong>Projects Loaded:</strong> ${projects.length}</div>
                            <div><strong>Active Projects:</strong> ${projects.filter(p => p.status === 'Active').length}</div>
                            <div><strong>Total Resources:</strong> ${projects.reduce((sum, p) => sum + (p.resources?.length || 0), 0)}</div>
                        </div>
                    </div>
                    
                    <!-- DATA MANAGEMENT -->
                    <div style="background: #F5F7FA; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;"> Data Management</h3>
                        <div style="display: grid; gap: 10px;">
                            <button onclick="exportData()" style="padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                 Export Full Backup (JSON)
                            </button>
                            <button onclick="document.getElementById('importFileAdmin').click()" style="padding: 10px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                 Import Data (JSON)
                            </button>
                            <input type="file" id="importFileAdmin" accept=".json" style="display: none;" onchange="importData(event)">
                            <button onclick="clearAllData()" style="padding: 10px; background: #EF5350; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                 Clear All Data (Requires Confirmation)
                            </button>
                        </div>
                    </div>
                    
                    <!-- SYSTEM INFO -->
                    <div style="background: #F5F7FA; padding: 20px; border-radius: 12px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;"> System Information</h3>
                        <div style="font-size: 12px; line-height: 1.8; color: #666;">
                            <div><strong>Dashboard Version:</strong> 5.5 (Role-Based Access)</div>
                            <div><strong>Storage Key:</strong> ${STORAGE_KEY}</div>
                            <div><strong>Last Data Update:</strong> ${new Date().toLocaleDateString()}</div>
                            <div><strong>Browser:</strong> ${navigator.userAgent.split(' ').pop()}</div>
                        </div>
                    </div>
                    
                    <button onclick="this.closest('div[style*=\"fixed\"]').remove()" style="margin-top: 20px; width: 100%; padding: 12px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function updateAccessCodes() {
            const newPM = document.getElementById('adminNewPMCode').value.trim();
            const newTeam = document.getElementById('adminNewTeamCode').value.trim();
            const newAdmin = document.getElementById('adminNewAdminCode').value.trim();
            
            if (!newPM || !newTeam || !newAdmin) {
                alert('All access codes must be filled in');
                return;
            }
            
            if (confirm('Update access codes for this session?\n\nNote: This only affects the current browser session. To make permanent changes, update the HTML file.')) {
                ACCESS_CODES.pm = newPM;
                ACCESS_CODES.team = newTeam;
                ACCESS_CODES.admin = newAdmin;
                
                alert(' Access codes updated successfully!\n\nNew codes:\nPM: ' + newPM + '\nTeam: ' + newTeam + '\nAdmin: ' + newAdmin);
            }
        }
        
        function clearAllData() {
            const confirmed = prompt(' WARNING: This will delete ALL project data!\n\nType "DELETE ALL DATA" to confirm:', '');
            
            if (confirmed === 'DELETE ALL DATA') {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(LEAVE_STORAGE_KEY);
                alert(' All data cleared. Page will reload.');
                location.reload();
            } else {
                alert(' Deletion cancelled');
            }
        }
        
        function initializeDashboard() {
            // Try to load data from server first (portfolio-data.json)
            loadFromServer()
                .then(() => {
                    console.log('Loaded data from server');
                })
                .catch(err => {
                    console.log('Could not load from server, using localStorage:', err.message);
                    loadFromLocalStorage();
                })
                .finally(() => {
                    loadLeaveFromStorage();
                    populateCalendarResourceSelect();
                    populateAIProjectSelect();
                    populateWhatIfProjectSelect();
                    initializeDateRangePickers();
                    
                    document.querySelectorAll('.btn-view').forEach(b => b.classList.remove('active'));
                    const viewBtn = document.getElementById('btn' + view.charAt(0).toUpperCase() + view.slice(1));
                    if (viewBtn) viewBtn.classList.add('active');
                    
                    // Register event handlers for edit modals
                    registerEditHandlers();
                    
                    render();
                    console.log('Dashboard initialized - Role:', userRole, '- Projects:', projects.length);
                    
                    // Start auto-refresh checks
                    startAutoRefresh();
                });
        }
        
        async function loadFromServer() {
            const response = await fetch('portfolio-data.json');
            if (!response.ok) {
                throw new Error('Could not fetch portfolio-data.json');
            }
            const data = await response.json();
            projects = data.projects || [];
            view = data.view || 'monthly';
            // Store timestamp for auto-refresh
            if (data.exportDate) {
                lastDataTimestamp = data.exportDate;
            }
            // Also save to localStorage for offline access
            saveToLocalStorage();
        }
        
        // AUTO-REFRESH FEATURE - Checks for updates every 5 minutes
        let lastDataTimestamp = null;
        let autoRefreshInterval = null;

        async function checkForUpdates() {
            try {
                const response = await fetch('portfolio-data.json?cache=' + Date.now());
                if (!response.ok) return;
                
                const data = await response.json();
                const currentTimestamp = data.exportDate;
                
                if (lastDataTimestamp === null) {
                    lastDataTimestamp = currentTimestamp;
                } else if (lastDataTimestamp !== currentTimestamp) {
                    showUpdateNotification();
                }
            } catch (err) {
                console.log('Update check failed:', err.message);
            }
        }

        function showUpdateNotification() {
            if (document.getElementById('updateNotification')) return;
            
            const notification = document.createElement('div');
            notification.id = 'updateNotification';
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); font-family: Segoe UI, sans-serif; animation: slideIn 0.5s ease-out;';
            
            notification.innerHTML = '<div style="display: flex; align-items: center; gap: 15px;"><div style="font-size: 32px;">&#128260;</div><div><div style="font-weight: 700; font-size: 16px; margin-bottom: 5px;">New Data Available!</div><div style="font-size: 13px; opacity: 0.9; margin-bottom: 10px;">The dashboard has been updated</div><button onclick="reloadDashboard()" style="background: white; color: #667eea; border: none; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px;">Refresh Now</button><button onclick="dismissNotification()" style="background: transparent; color: white; border: 1px solid white; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; margin-left: 10px;">Dismiss</button></div></div>';
            
            const style = document.createElement('style');
            style.textContent = '@keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }';
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
        }

        function reloadDashboard() {
            window.location.reload(true);
        }

        function dismissNotification() {
            const notification = document.getElementById('updateNotification');
            if (notification) {
                notification.remove();
            }
            fetch('portfolio-data.json?cache=' + Date.now())
                .then(r => r.json())
                .then(data => lastDataTimestamp = data.exportDate);
        }

        function startAutoRefresh() {
            autoRefreshInterval = setInterval(checkForUpdates, 300000);
            console.log('Auto-refresh started - checking every 5 minutes');
        }
        
        function registerEditHandlers() {
            // Edit allocation slider for full edit modal
            const editSlider = document.getElementById('editAllocationSlider');
            if (editSlider) {
                editSlider.addEventListener('input', updateDailyHoursDisplay);
            }
            
            // Full edit button click
            const fullSaveBtn = document.getElementById('fullSaveBtn');
            if (fullSaveBtn) {
                fullSaveBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (!currentEditResource || !currentEditProject) {
                        alert('Error: No resource or project selected');
                        return false;
                    }
                    
                    const plannedHours = parseFloat(document.getElementById('editPlannedHours').value);
                    const allocation = parseInt(document.getElementById('editAllocationSlider').value);
                    const startDate = document.getElementById('editStartDate').value;
                    const endDate = document.getElementById('editEndDate').value;
                    
                    if (new Date(startDate) > new Date(endDate)) {
                        alert('Start date must be before end date');
                        return false;
                    }
                    
                    const project = projects.find(p => p.name === currentEditProject);
                    const resource = project.resources.find(r => r.name === currentEditResource);
                    
                    if (resource) {
                        resource.plannedHours = plannedHours;
                        resource.allocation = allocation;
                        resource.startDate = startDate;
                        resource.endDate = endDate;
                        
                        saveToLocalStorage();
                        renderCalendar();
                        showResourceSummary(currentEditResource);
                        showNotification(' Resource allocation updated successfully!', 'success');
                        closeEditAllocationModal();
                    } else {
                        alert('Error: Could not find resource to update');
                    }
                    
                    return false;
                };
            }
            
            // Quick edit button click
            const quickSaveBtn = document.getElementById('quickSaveBtn');
            if (quickSaveBtn) {
                quickSaveBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Quick Save clicked');
                    
                    if (!currentDayEdit) {
                        alert('Error: No allocation selected');
                        return false;
                    }
                    
                    const resourceName = currentDayEdit.resourceName;
                    const projectName = currentDayEdit.projectName;
                    const newAllocation = parseInt(document.getElementById('dayEditAllocationSlider').value);
                    
                    console.log('Saving:', resourceName, projectName, newAllocation + '%');
                    
                    const project = projects.find(p => p.name === projectName);
                    if (!project) {
                        alert('Error: Project not found');
                        return false;
                    }
                    
                    const resource = project.resources.find(r => r.name === resourceName);
                    
                    if (resource) {
                        const oldAllocation = resource.allocation;
                        const oldDailyHours = (oldAllocation / 100) * 8;
                        const newDailyHours = (newAllocation / 100) * 8;
                        
                        // Update allocation
                        resource.allocation = newAllocation;
                        console.log('Updated allocation from', oldAllocation + '%', 'to', newAllocation + '%');
                        
                        // Save to localStorage
                        saveToLocalStorage();
                        
                        // Close modal
                        closeEditDayModal();
                        
                        // Ensure resource is still selected in dropdown
                        const resourceSelect = document.getElementById('calendarResourceSelect');
                        if (resourceSelect && resourceSelect.value !== resourceName) {
                            resourceSelect.value = resourceName;
                        }
                        
                        // Force calendar refresh
                        console.log('Refreshing calendar for resource:', resourceName);
                        renderCalendar();
                        showResourceSummary(resourceName);
                        
                        // Show success message
                        showNotification(
                            ` Updated ${projectName}: ${oldDailyHours.toFixed(1)}h  ${newDailyHours.toFixed(1)}h/day (${newAllocation}%)`, 
                            'success'
                        );
                        
                        console.log('Save complete');
                    } else {
                        alert('Error: Could not find resource to update');
                    }
                    
                    return false;
                };
            }
        }
        
        // ===== DASHBOARD DATA =====
        let projects = [
    {
        "name": "J000332 ARRCS | Finance & Payroll Implementation",
        "type": "Won",
        "status": "Active",
        "health": "Delayed",
        "client": "Australian Regional and Remote Community Services (ARRCS)",
        "manager": "Sharon Chong",
        "budget": 436000,
        "effortBudget": 1938,
        "actualEffort": 1802,
        "startDate": "2024-09-23",
        "endDate": "2025-11-14",
        "progress": 99,
        "updates": "The project total effort has been completed, and the project is on hold. However, there is still $40K within the original budget.\nThe PM (Sharon) to confirm next steps, including closure/change request ",
        "resources": [
            {
                "name": "Sharon",
                "role": "Project Manager",
                "plannedHours": 1232,
                "actualHours": 1148,
                "allocation": 5,
                "startDate": "2024-09-23",
                "endDate": "2025-11-14"
            },
            {
                "name": "Barbara",
                "role": "Business Analyst",
                "plannedHours": 376,
                "actualHours": 243,
                "allocation": 60,
                "startDate": "2024-11-01",
                "endDate": "2025-11-26"
            },
            {
                "name": "Rowan",
                "role": "Change Manager",
                "plannedHours": 160,
                "actualHours": 125,
                "allocation": 80,
                "startDate": "2024-10-11",
                "endDate": "2025-05-16"
            },
            {
                "name": "Ian",
                "role": "Project Director",
                "plannedHours": 40,
                "actualHours": 45,
                "allocation": 20,
                "startDate": "2024-10-21",
                "endDate": "2025-07-31"
            },
            {
                "name": "Kevin",
                "role": "Tech Lead",
                "plannedHours": 112,
                "actualHours": 158,
                "allocation": 60,
                "startDate": "2025-02-03",
                "endDate": "2025-07-26"
            }
        ],
        "collapsed": false
    },
    {
        "name": "J000342 Carrington Care | Consulting Support",
        "type": "Won",
        "status": "Active",
        "health": "On Track",
        "client": "Carrington Care",
        "manager": "Ian",
        "budget": 40000,
        "effortBudget": 160,
        "actualEffort": 156,
        "startDate": "2025-01-10",
        "endDate": "2025-12-19",
        "progress": 85,
        "updates": "The project has less than 3.45 hours remaining on the budget. Further PCR is required ",
        "resources": [
            {
                "name": "Ian",
                "role": "Project Manager",
                "plannedHours": 58,
                "actualHours": 38,
                "allocation": 10,
                "startDate": "2025-01-21",
                "endDate": "2025-11-29"
            },
            {
                "name": "Kal",
                "role": "Tech Lead",
                "plannedHours": 102,
                "actualHours": 36,
                "allocation": 10,
                "startDate": "2025-10-07",
                "endDate": "2025-11-27"
            }
        ],
        "collapsed": true
    },
    {
        "name": "J000344 Uniting | Support at Home and RAC  Transition Solution (Finance)  Plan and Implement",
        "type": "Won",
        "status": "Active",
        "health": "On Track",
        "client": "Uniting (NSW.ACT)",
        "manager": "Allanah",
        "budget": 884000,
        "effortBudget": 3616,
        "actualEffort": 3439,
        "startDate": "2025-01-24",
        "endDate": "2025-12-15",
        "progress": 90,
        "updates": "A new PCR ($23K) has been submitted and awaiting approval ",
        "resources": [
            {
                "name": "Allanah",
                "role": "Project Manager",
                "plannedHours": 1208,
                "actualHours": 1416,
                "allocation": 100,
                "startDate": "2025-01-24",
                "endDate": "2025-12-15"
            },
            {
                "name": "Kaman",
                "role": "Business Analyst",
                "plannedHours": 1636,
                "actualHours": 1234,
                "allocation": 60,
                "startDate": "2025-01-24",
                "endDate": "2025-11-27"
            },
            {
                "name": "Kal",
                "role": "Business Analyst",
                "plannedHours": 268,
                "actualHours": 208,
                "allocation": 10,
                "startDate": "2025-01-24",
                "endDate": "2025-06-24"
            },
            {
                "name": "Darren",
                "role": "Project Director",
                "plannedHours": 248,
                "actualHours": 218,
                "allocation": 10,
                "startDate": "2025-01-28",
                "endDate": "2025-11-28"
            }
        ],
        "collapsed": false
    },
    {
        "name": "J000351 - Uniting | Billing Solution Design & Build Bridging",
        "type": "Won",
        "status": "Active",
        "health": "At Risk",
        "client": "Uniting (NSW.ACT)",
        "manager": "Sharon",
        "budget": 1389750,
        "effortBudget": 5952,
        "actualEffort": 5898,
        "startDate": "2025-07-01",
        "endDate": "2026-04-30",
        "progress": 95,
        "updates": "Project is At Risk.\nThe build SOW is on hold, and Uniting requesting 2 specific workshops (Integration & Data Migration) to determine the next steps.\n\nAt this point in time, Uniting has asked to effectively put all resources (Integration & Data Migration) resources on hold post 21st of November. Uniting and Rohling will need to determine and agree on next steps post 21st of November. ",
        "resources": [
            {
                "name": "Sharon",
                "role": "Project Manager",
                "plannedHours": 648,
                "actualHours": 631,
                "allocation": 100,
                "startDate": "2025-07-01",
                "endDate": "2026-04-24"
            },
            {
                "name": "Kevin",
                "role": "Tech Lead",
                "plannedHours": 648,
                "actualHours": 651,
                "allocation": 85,
                "startDate": "2025-07-14",
                "endDate": "2025-12-08"
            },
            {
                "name": "Barbara",
                "role": "Business Analyst",
                "plannedHours": 600,
                "actualHours": 648,
                "allocation": 100,
                "startDate": "2025-07-07",
                "endDate": "2026-01-27"
            },
            {
                "name": "Jennifer",
                "role": "Business Analyst",
                "plannedHours": 600,
                "actualHours": 647,
                "allocation": 80,
                "startDate": "2025-07-21",
                "endDate": "2025-11-27"
            },
            {
                "name": "Jack",
                "role": "Tech Lead",
                "plannedHours": 648,
                "actualHours": 764,
                "allocation": 80,
                "startDate": "2025-07-07",
                "endDate": "2025-11-28"
            },
            {
                "name": "Gerard",
                "role": "Tech Lead",
                "plannedHours": 648,
                "actualHours": 714,
                "allocation": 90,
                "startDate": "2025-07-01",
                "endDate": "2026-01-30"
            },
            {
                "name": "EVORA (2 x RC)",
                "role": "Tech Lead",
                "plannedHours": 1576,
                "actualHours": 1384,
                "allocation": 100,
                "startDate": "2025-07-07",
                "endDate": "2026-01-30"
            },
            {
                "name": "Darren",
                "role": "Project Director",
                "plannedHours": 160,
                "actualHours": 185,
                "allocation": 20,
                "startDate": "2025-07-07",
                "endDate": "2025-11-28"
            },
            {
                "name": "Matt",
                "role": "Tech Lead",
                "plannedHours": 328,
                "actualHours": 166,
                "allocation": 80,
                "startDate": "2025-09-24",
                "endDate": "2025-11-10"
            }
        ],
        "collapsed": true
    },
    {
        "name": "J000356 Videri | IT Strategy",
        "type": "Won",
        "status": "Active",
        "health": "On Track",
        "client": "Videri Australia",
        "manager": "Renee",
        "budget": 66600,
        "effortBudget": 244,
        "actualEffort": 169,
        "startDate": "2025-09-01",
        "endDate": "2025-11-28",
        "progress": 85,
        "updates": "We're still under the budget and Renee to utilise John's allocated effort. A new PCR for the workshop to be submitted ",
        "resources": [
            {
                "name": "Renee",
                "role": "Project Manager",
                "plannedHours": 48,
                "actualHours": 55,
                "allocation": 60,
                "startDate": "2025-09-01",
                "endDate": "2025-11-28"
            },
            {
                "name": "Ian",
                "role": "Project Director",
                "plannedHours": 64,
                "actualHours": 46,
                "allocation": 60,
                "startDate": "2025-09-01",
                "endDate": "2025-11-28"
            },
            {
                "name": "Kal",
                "role": "Tech Lead",
                "plannedHours": 48,
                "actualHours": 38,
                "allocation": 10,
                "startDate": "2025-09-01",
                "endDate": "2025-11-28"
            },
            {
                "name": "Kaman",
                "role": "Business Analyst",
                "plannedHours": 24,
                "actualHours": 29,
                "allocation": 20,
                "startDate": "2025-09-01",
                "endDate": "2025-10-31"
            },
            {
                "name": "Kevin",
                "role": "Tech Lead",
                "plannedHours": 30,
                "actualHours": 0,
                "allocation": 10,
                "startDate": "2025-11-10",
                "endDate": "2025-11-28"
            },
            {
                "name": "John",
                "role": "Other",
                "plannedHours": 30,
                "actualHours": 0,
                "allocation": 10,
                "startDate": "2025-11-04",
                "endDate": "2025-11-28"
            }
        ],
        "collapsed": true
    },
    {
        "name": "000352 - J000352 - CatholicCare | Horizon Implementation",
        "type": "Won",
        "status": "Active",
        "health": "On Track",
        "client": "Catholic Care ",
        "manager": "Brett",
        "budget": 390117,
        "effortBudget": 9680,
        "actualEffort": 1856,
        "startDate": "2025-07-07",
        "endDate": "2026-07-01",
        "progress": 25,
        "updates": "The project requires a new BA resource to replace Stephen, who will be completing his role by the end of November 2025. Gerard to also perform some activities ",
        "resources": [
            {
                "name": "Brett",
                "role": "Project Manager",
                "plannedHours": 3280,
                "actualHours": 664,
                "allocation": 100,
                "startDate": "2025-07-07",
                "endDate": "2026-07-01"
            },
            {
                "name": "Pamela",
                "role": "Change Manager",
                "plannedHours": 1920,
                "actualHours": 456,
                "allocation": 40,
                "startDate": "2025-09-08",
                "endDate": "2026-05-28"
            },
            {
                "name": "Stephen",
                "role": "Business Analyst",
                "plannedHours": 3280,
                "actualHours": 664,
                "allocation": 80,
                "startDate": "2025-07-21",
                "endDate": "2026-06-19"
            },
            {
                "name": "Renee",
                "role": "Other",
                "plannedHours": 800,
                "actualHours": 71,
                "allocation": 10,
                "startDate": "2025-10-06",
                "endDate": "2026-06-30"
            }
        ],
        "collapsed": true
    },
    {
        "name": "J000345 BaptistCare NSW and ACT | Homecare Solution Architecture",
        "type": "Won",
        "status": "Active",
        "health": "On Track",
        "client": "aptistCare NSW and ACT",
        "manager": "Jayson",
        "budget": 460500,
        "effortBudget": 1960,
        "actualEffort": 1560,
        "startDate": "2025-01-30",
        "endDate": "2026-01-31",
        "progress": 80,
        "updates": "Project on-track with approved PCR",
        "resources": [
            {
                "name": "Jayson",
                "role": "Project Manager",
                "plannedHours": 1960,
                "actualHours": 1560,
                "allocation": 80,
                "startDate": "2025-01-30",
                "endDate": "2026-01-31"
            }
        ],
        "collapsed": true
    },
    {
        "name": "RSL Lifecare - Clinical System Assessment ",
        "type": "Proposal",
        "status": "Active",
        "health": "On Track",
        "client": "RSL Lifecare",
        "manager": "Renee",
        "budget": 59400,
        "effortBudget": 240,
        "actualEffort": 0,
        "startDate": "2025-12-01",
        "endDate": "2026-01-31",
        "progress": 1,
        "updates": "Project to be kicked off in December ",
        "resources": [
            {
                "name": "Renee",
                "role": "Project Manager",
                "plannedHours": 64,
                "actualHours": 0,
                "allocation": 0,
                "startDate": "2025-12-01",
                "endDate": "2026-01-30"
            },
            {
                "name": "Ali Kaabi",
                "role": "Project Director",
                "plannedHours": 16,
                "actualHours": 0,
                "allocation": 0,
                "startDate": "2025-12-01",
                "endDate": "2026-01-30"
            },
            {
                "name": "Barbara",
                "role": "Business Analyst",
                "plannedHours": 80,
                "actualHours": 0,
                "allocation": 0,
                "startDate": "2025-12-01",
                "endDate": "2026-01-30"
            },
            {
                "name": "Kevin",
                "role": "Tech Lead",
                "plannedHours": 80,
                "actualHours": 0,
                "allocation": 0,
                "startDate": "2025-12-01",
                "endDate": "2026-01-30"
            }
        ],
        "collapsed": true
    },
    {
        "name": "RSL Lifecare - CRM, Billing & Integration Solution Assessment ",
        "type": "Proposal",
        "status": "Active",
        "health": "On Track",
        "client": "RSL Lifecare",
        "manager": "Allanah ",
        "budget": 118600,
        "effortBudget": 480,
        "actualEffort": 0,
        "startDate": "2025-12-08",
        "endDate": "2026-02-27",
        "progress": 0,
        "updates": "Project to be kicked off on December",
        "resources": [
            {
                "name": "Ali Kaabi",
                "role": "Project Director",
                "plannedHours": 16,
                "actualHours": 0,
                "allocation": 0,
                "startDate": "2025-12-08",
                "endDate": "2026-02-27"
            },
            {
                "name": "Allanah",
                "role": "Project Manager",
                "plannedHours": 120,
                "actualHours": 0,
                "allocation": 0,
                "startDate": "2025-12-08",
                "endDate": "2026-02-27"
            },
            {
                "name": "Barbara ",
                "role": "Business Analyst",
                "plannedHours": 144,
                "actualHours": 0,
                "allocation": 0,
                "startDate": "2025-12-08",
                "endDate": "2026-02-27"
            },
            {
                "name": "Kevin",
                "role": "Tech Lead",
                "plannedHours": 200,
                "actualHours": 0,
                "allocation": 0,
                "startDate": "2025-12-08",
                "endDate": "2026-02-27"
            }
        ],
        "collapsed": true
    }
];
        let view = 'quarterly';
        let editingProject = -1;
        let editingResource = { projIdx: -1, resIdx: -1 };
        
        const STORAGE_KEY = 'rohling_portfolio_v3_1_fresh'; // NEW KEY TO FORCE DATA RELOAD
        
        // REAL DATA FROM JSON
        const sampleProjects = [
  {
    "name": "J000332 ARRCS | Finance & Payroll Implementation",
    "type": "Won",
    "status": "Active",
    "health": "Delayed",
    "client": "Australian Regional and Remote Community Services (ARRCS)",
    "manager": "Sharon Chong",
    "budget": 436000,
    "effortBudget": 1938,
    "actualEffort": 1802,
    "startDate": "2024-09-23",
    "endDate": "2025-11-14",
    "progress": 100,
    "updates": "The project total effort has been completed, and the project is on hold. However, there is still $40K within the original budget.\nThe PM (Sharon) to confirm next steps, including closure/change request ",
    "resources": [
      {
        "name": "Sharon",
        "role": "Project Manager",
        "plannedHours": 984,
        "actualHours": 0,
        "allocation": 100,
        "startDate": "2024-09-23",
        "endDate": "2025-11-14"
      },
      {
        "name": "Barbara",
        "role": "Business Analyst",
        "plannedHours": 376,
        "actualHours": 0,
        "allocation": 80,
        "startDate": "2024-11-01",
        "endDate": "2025-09-26"
      },
      {
        "name": "Kal",
        "role": "Tech Lead",
        "plannedHours": 18,
        "actualHours": 0,
        "allocation": 90,
        "startDate": "2025-10-13",
        "endDate": "2025-10-31"
      },
      {
        "name": "Rowan",
        "role": "Change Manager",
        "plannedHours": 160,
        "actualHours": 0,
        "allocation": 80,
        "startDate": "2024-10-11",
        "endDate": "2025-05-16"
      },
      {
        "name": "Ian",
        "role": "Project Director",
        "plannedHours": 56,
        "actualHours": 0,
        "allocation": 90,
        "startDate": "2024-10-21",
        "endDate": "2025-07-31"
      },
      {
        "name": "Kevin",
        "role": "Tech Lead",
        "plannedHours": 110,
        "actualHours": 0,
        "allocation": 90,
        "startDate": "2025-02-03",
        "endDate": "2025-07-26"
      }
    ]
  },
  {
    "name": "J000342 Carrington Care | Consulting Support",
    "type": "Won",
    "status": "Active",
    "health": "On Track",
    "client": "Carrington Care",
    "manager": "Ian",
    "budget": 40000,
    "effortBudget": 160,
    "actualEffort": 129,
    "startDate": "2025-01-10",
    "endDate": "2025-12-19",
    "progress": 80,
    "updates": "Only 30 hours remaining left for the project ",
    "resources": [
      {
        "name": "Ian",
        "role": "Project Manager",
        "plannedHours": 116,
        "actualHours": 0,
        "allocation": 100,
        "startDate": "2025-01-21",
        "endDate": "2025-10-27"
      },
      {
        "name": "Kal",
        "role": "Tech Lead",
        "plannedHours": 15,
        "actualHours": 0,
        "allocation": 90,
        "startDate": "2025-10-07",
        "endDate": "2025-10-27"
      }
    ]
  },
  {
    "name": "J000344 Uniting | Support at Home and RAC  Transition Solution (Finance)  Plan and Implement",
    "type": "Won",
    "status": "Active",
    "health": "On Track",
    "client": "Uniting (NSW.ACT)",
    "manager": "Allanah",
    "budget": 884000,
    "effortBudget": 3616,
    "actualEffort": 3255,
    "startDate": "2025-01-24",
    "endDate": "2025-12-12",
    "progress": 85,
    "updates": "Project is in the last phase of testing with an aim to go live by the end of November ",
    "resources": [
      {
        "name": "Allanah",
        "role": "Project Manager",
        "plannedHours": 520,
        "actualHours": 0,
        "allocation": 85,
        "startDate": "2025-01-24",
        "endDate": "2025-12-12"
      },
      {
        "name": "Kaman",
        "role": "Business Analyst",
        "plannedHours": 640,
        "actualHours": 0,
        "allocation": 85,
        "startDate": "2025-01-24",
        "endDate": "2025-11-27"
      },
      {
        "name": "Kal",
        "role": "Business Analyst",
        "plannedHours": 160,
        "actualHours": 0,
        "allocation": 100,
        "startDate": "2025-01-24",
        "endDate": "2025-06-24"
      },
      {
        "name": "Darren",
        "role": "Project Director",
        "plannedHours": 104,
        "actualHours": 0,
        "allocation": 100,
        "startDate": "2025-01-28",
        "endDate": "2025-11-28"
      }
    ]
  },
  {
    "name": "J000351 - Uniting | Billing Solution Design & Build Bridging",
    "type": "Won",
    "status": "Active",
    "health": "On Track",
    "client": "Uniting (NSW.ACT)",
    "manager": "Sharon",
    "budget": 1389750,
    "effortBudget": 5952,
    "actualEffort": 5229,
    "startDate": "2025-07-01",
    "endDate": "2026-04-30",
    "progress": 10,
    "updates": "Epicore solution\nWe are very close to the budget, the new SOW is required immediately for the further billing",
    "resources": [
      {
        "name": "Sharon",
        "role": "Project Manager",
        "plannedHours": 648,
        "actualHours": 0,
        "allocation": 70,
        "startDate": "2025-07-01",
        "endDate": "2026-04-24"
      },
      {
        "name": "Kevin",
        "role": "Tech Lead",
        "plannedHours": 648,
        "actualHours": 0,
        "allocation": 80,
        "startDate": "2025-07-14",
        "endDate": "2025-12-08"
      },
      {
        "name": "Barbara",
        "role": "Business Analyst",
        "plannedHours": 693,
        "actualHours": 0,
        "allocation": 60,
        "startDate": "2025-07-07",
        "endDate": "2026-01-27"
      },
      {
        "name": "Jennifer",
        "role": "Business Analyst",
        "plannedHours": 600,
        "actualHours": 0,
        "allocation": 80,
        "startDate": "2025-07-21",
        "endDate": "2025-11-27"
      },
      {
        "name": "Jack",
        "role": "Tech Lead",
        "plannedHours": 648,
        "actualHours": 0,
        "allocation": 80,
        "startDate": "2025-07-07",
        "endDate": "2025-11-28"
      },
      {
        "name": "Gerard",
        "role": "Tech Lead",
        "plannedHours": 648,
        "actualHours": 0,
        "allocation": 90,
        "startDate": "2025-07-01",
        "endDate": "2026-01-30"
      },
      {
        "name": "EVORA (2 x RC)",
        "role": "Tech Lead",
        "plannedHours": 1580,
        "actualHours": 0,
        "allocation": 90,
        "startDate": "2025-07-07",
        "endDate": "2026-01-30"
      },
      {
        "name": "Darren",
        "role": "Project Director",
        "plannedHours": 160,
        "actualHours": 0,
        "allocation": 100,
        "startDate": "2025-07-07",
        "endDate": "2025-10-20"
      },
      {
        "name": "Matt",
        "role": "Tech Lead",
        "plannedHours": 328,
        "actualHours": 0,
        "allocation": 40,
        "startDate": "2025-09-24",
        "endDate": "2025-11-13"
      }
    ]
  },
  {
    "name": "J000356 Videri | IT Strategy",
    "type": "Won",
    "status": "Active",
    "health": "On Track",
    "client": "Videri Australia",
    "manager": "Renee",
    "budget": 66600,
    "effortBudget": 244,
    "actualEffort": 143,
    "startDate": "2025-09-01",
    "endDate": "2025-11-28",
    "progress": 80,
    "updates": "There will be a new PCR as the team have discovered more work ",
    "resources": [
      {
        "name": "Renee",
        "role": "Project Manager",
        "plannedHours": 48,
        "actualHours": 0,
        "allocation": 90,
        "startDate": "2025-09-01",
        "endDate": "2025-11-28"
      },
      {
        "name": "Ian",
        "role": "Project Director",
        "plannedHours": 64,
        "actualHours": 0,
        "allocation": 60,
        "startDate": "2025-09-01",
        "endDate": "2025-11-28"
      },
      {
        "name": "Kal",
        "role": "Tech Lead",
        "plannedHours": 48,
        "actualHours": 0,
        "allocation": 60,
        "startDate": "2025-09-01",
        "endDate": "2025-11-28"
      },
      {
        "name": "Kaman",
        "role": "Business Analyst",
        "plannedHours": 24,
        "actualHours": 0,
        "allocation": 100,
        "startDate": "2025-09-01",
        "endDate": "2025-10-31"
      }
    ]
  },
  {
    "name": "000352 - J000352 - CatholicCare | Horizon Implementation",
    "type": "Won",
    "status": "Active",
    "health": "On Track",
    "client": "Catholic Care ",
    "manager": "Brett",
    "budget": 390117,
    "effortBudget": 9680,
    "actualEffort": 1630,
    "startDate": "2025-07-07",
    "endDate": "2026-07-01",
    "progress": 10,
    "updates": "The project requires a new BA resource to replace Stephen, who will be completing his role by the end of November 2025.",
    "resources": [
      {
        "name": "Bret",
        "role": "Project Manager",
        "plannedHours": 328,
        "actualHours": 0,
        "allocation": 10,
        "startDate": "2025-07-07",
        "endDate": "2026-07-01"
      },
      {
        "name": "Pamela",
        "role": "Change Manager",
        "plannedHours": 1920,
        "actualHours": 0,
        "allocation": 10,
        "startDate": "2025-09-08",
        "endDate": "2026-05-28"
      },
      {
        "name": "Stephen",
        "role": "Business Analyst",
        "plannedHours": 3280,
        "actualHours": 0,
        "allocation": 10,
        "startDate": "2025-07-21",
        "endDate": "2026-02-13"
      },
      {
        "name": "Gerard",
        "role": "Tech Lead",
        "plannedHours": 400,
        "actualHours": 0,
        "allocation": 10,
        "startDate": "2025-08-18",
        "endDate": "2026-03-19"
      },
      {
        "name": "Renee",
        "role": "Other",
        "plannedHours": 800,
        "actualHours": 0,
        "allocation": 10,
        "startDate": "2025-10-06",
        "endDate": "2026-06-30"
      }
    ]
  },
  {
    "name": "J000345 BaptistCare NSW and ACT | Homecare Solution Architecture",
    "type": "Won",
    "status": "Active",
    "health": "On Track",
    "client": "aptistCare NSW and ACT",
    "manager": "Jayson",
    "budget": 460500,
    "effortBudget": 1960,
    "actualEffort": 1560,
    "startDate": "2025-01-30",
    "endDate": "2026-01-31",
    "progress": 70,
    "updates": "Project on-track with approved PCR",
    "resources": [
      {
        "name": "Jayson",
        "role": "Project Manager",
        "plannedHours": 1960,
        "actualHours": 0,
        "allocation": 80,
        "startDate": "2025-01-30",
        "endDate": "2026-01-31"
      }
    ]
  }
];
        
        function saveToLocalStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ projects, view }));
        }
        
        function loadFromLocalStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                projects = data.projects || [];
                view = data.view || 'monthly';
            } else {
                projects = sampleProjects;
            }
        }
        
        function exportData() {
            // Create backup with timestamp
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
            const filename = `Rohling-Portfolio-Backup-${timestamp}.json`;
            
            // Export all data
            const exportObj = {
                projects: projects,
                view: view,
                exportDate: new Date().toISOString(),
                version: '4.0'
            };
            
            const dataStr = JSON.stringify(exportObj, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            
            // Clean up
            URL.revokeObjectURL(url);
            
            // Show confirmation
            showNotification(` Data exported: ${filename}`, 'success');
            
            console.log('Exported data:', exportObj);
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        projects = data.projects || [];
                        view = data.view || 'monthly';
                        saveToLocalStorage();
                        
                        // Refresh all views
                        render();
                        populateCalendarResourceSelect();
                        renderCalendar();
                        
                        alert(' Data imported successfully!\n\nAll your projects, resources, and day-specific hours have been restored.');
                    } catch (err) {
                        alert(' Error importing data: ' + err.message + '\n\nPlease make sure you selected a valid backup file.');
                    }
                };
                reader.readAsText(file);
            }
            
            // Reset the file input so you can import the same file again
            event.target.value = '';
        }
        
        function changeView(newView) {
            view = newView;
            saveToLocalStorage();
            document.querySelectorAll('.btn-view').forEach(b => b.classList.remove('active'));
            document.getElementById('btn' + newView.charAt(0).toUpperCase() + newView.slice(1)).classList.add('active');
            render();
        }
        
        function getTimelineRange() {
            if (projects.length === 0) {
                const today = new Date();
                const futureDate = new Date(today);
                futureDate.setMonth(today.getMonth() + 12);
                return { start: today, end: futureDate };
            }
            
            let earliest = new Date(projects[0].startDate);
            let latest = new Date(projects[0].endDate);
            
            projects.forEach(proj => {
                const start = new Date(proj.startDate);
                const end = new Date(proj.endDate);
                if (start < earliest) earliest = start;
                if (end > latest) latest = end;
                
                proj.resources.forEach(res => {
                    const rStart = new Date(res.startDate);
                    const rEnd = new Date(res.endDate);
                    if (rStart < earliest) earliest = rStart;
                    if (rEnd > latest) latest = rEnd;
                });
            });
            
            earliest.setDate(1);
            latest.setMonth(latest.getMonth() + 1);
            latest.setDate(0);
            
            return { start: earliest, end: latest };
        }
        
        function generateTimeline() {
            const { start, end } = getTimelineRange();
            const timeline = [];
            
            let current = new Date(start);
            
            if (view === 'weekly') {
                while (current <= end) {
                    timeline.push(new Date(current));
                    current.setDate(current.getDate() + 7);
                }
            } else if (view === 'biweekly') {
                while (current <= end) {
                    timeline.push(new Date(current));
                    current.setDate(current.getDate() + 14);
                }
            } else if (view === 'monthly') {
                while (current <= end) {
                    timeline.push(new Date(current));
                    current.setMonth(current.getMonth() + 1);
                }
            } else if (view === 'quarterly') {
                while (current <= end) {
                    timeline.push(new Date(current));
                    current.setMonth(current.getMonth() + 3);
                }
            }
            
            return timeline;
        }
        
        function formatTimelineLabel(date) {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear().toString().slice(-2);
            
            if (view === 'weekly' || view === 'biweekly') {
                const day = date.getDate();
                return `${day} ${month}`;
            } else if (view === 'quarterly') {
                const quarter = Math.floor(date.getMonth() / 3) + 1;
                return `Q${quarter} ${year}`;
            } else {
                return `${month} ${year}`;
            }
        }
        
        function renderTimelineHeader() {
            const timeline = generateTimeline();
            const headerDiv = document.getElementById('timeline-header');
            
            const monthsMap = new Map();
            timeline.forEach(date => {
                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                if (!monthsMap.has(monthKey)) {
                    monthsMap.set(monthKey, []);
                }
                monthsMap.get(monthKey).push(date);
            });
            
            let monthsHTML = '';
            let weeksHTML = '';
            
            monthsMap.forEach((dates, monthKey) => {
                const firstDate = dates[0];
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const label = `${monthNames[firstDate.getMonth()]} ${firstDate.getFullYear().toString().slice(-2)}`;
                const width = (dates.length / timeline.length) * 100;
                monthsHTML += `<div class="month-cell" style="flex: ${dates.length}">${label}</div>`;
            });
            
            timeline.forEach(date => {
                const label = formatTimelineLabel(date);
                weeksHTML += `<div class="week-cell" style="flex: 1">${label}</div>`;
            });
            
            headerDiv.innerHTML = `
                <div class="timeline-header-wrapper">
                    <div class="header-spacer">Timeline View</div>
                    <div class="header-timeline">
                        <div class="months-header">${monthsHTML}</div>
                        <div class="weeks-header">${weeksHTML}</div>
                    </div>
                </div>
            `;
        }
        
        function calculatePosition(startDate, endDate, timelineStart, timelineEnd) {
            const totalDuration = timelineEnd - timelineStart;
            const itemStart = new Date(startDate) - timelineStart;
            const itemDuration = new Date(endDate) - new Date(startDate);
            
            const left = (itemStart / totalDuration) * 100;
            const width = (itemDuration / totalDuration) * 100;
            
            return {
                left: Math.max(0, left),
                width: Math.max(1, width)
            };
        }
        
        function getRoleClass(role) {
            const roleMap = {
                'Project Manager': 'role-pm',
                'Business Analyst': 'role-ba',
                'Tech Lead': 'role-tl',
                'Project Director': 'role-pd',
                'Change Manager': 'role-cm',
                'Other': 'role-other'
            };
            return roleMap[role] || 'role-other';
        }
        
        function getStatusClass(health) {
            const statusMap = {
                'On Track': 'status-on-track',
                'At Risk': 'status-at-risk',
                'Delayed': 'status-delayed'
            };
            return statusMap[health] || 'status-on-track';
        }
        
        function getBudgetStatus(planned, actual) {
            if (actual === 0) return { class: 'budget-green', text: 'Not Started', percent: 0 };
            const percent = Math.round((actual / planned) * 100);
            if (percent <= 90) return { class: 'budget-green', text: `${percent}%`, percent };
            if (percent <= 100) return { class: 'budget-amber', text: `${percent}%`, percent };
            return { class: 'budget-red', text: `${percent}% OVER`, percent };
        }
        
        function renderUtilizationDashboard() {
            const utilGrid = document.getElementById('utilizationGrid');
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const selectedResource = document.getElementById('resourceFilter').value;
            
            // Calculate resource utilization with allocation percentages
            const resourceMap = new Map();
            
            projects.forEach(proj => {
                proj.resources.forEach(res => {
                    // Apply date range filter if set
                    let includeResource = true;
                    if (dateFrom || dateTo) {
                        const resStart = new Date(res.startDate);
                        const resEnd = new Date(res.endDate);
                        const filterStart = dateFrom ? new Date(dateFrom) : new Date('1900-01-01');
                        const filterEnd = dateTo ? new Date(dateTo) : new Date('2100-12-31');
                        
                        // Check if resource period overlaps with filter period
                        includeResource = resStart <= filterEnd && resEnd >= filterStart;
                    }
                    
                    // Apply resource filter if set
                    if (selectedResource && res.name !== selectedResource) {
                        includeResource = false;
                    }
                    
                    if (includeResource) {
                        if (!resourceMap.has(res.name)) {
                            resourceMap.set(res.name, {
                                name: res.name,
                                totalPlanned: 0,
                                totalActual: 0,
                                totalAllocation: 0,
                                assignments: []
                            });
                        }
                        const resource = resourceMap.get(res.name);
                        resource.totalPlanned += res.plannedHours || 0;
                        resource.totalActual += res.actualHours || 0;
                        resource.totalAllocation += res.allocation || 0;
                        resource.assignments.push({
                            project: proj.name,
                            allocation: res.allocation,
                            hours: res.plannedHours,
                            startDate: res.startDate,
                            endDate: res.endDate
                        });
                    }
                });
            });
            
            // Convert to array and sort by total allocation descending
            const resources = Array.from(resourceMap.values()).sort((a, b) => b.totalAllocation - a.totalAllocation);
            
            let html = '';
            resources.forEach(res => {
                const totalAllocationPercent = res.totalAllocation;
                const daysPerWeek = (totalAllocationPercent / 20).toFixed(1); // 100% = 5 days, 20% = 1 day
                let statusClass = 'healthy';
                let barClass = 'green';
                
                if (totalAllocationPercent > 100) {
                    statusClass = 'overallocated';
                    barClass = 'red';
                } else if (totalAllocationPercent >= 80) {
                    statusClass = 'nearfull';
                    barClass = 'amber';
                }
                
                const barWidth = Math.min(totalAllocationPercent, 100);
                
                html += `
                    <div class="utilization-card ${statusClass}">
                        <h4>
                            <span>${res.name}</span>
                            <span class="days-per-week">${daysPerWeek} days/week</span>
                        </h4>
                        <div class="utilization-bar">
                            <div class="utilization-fill ${barClass}" style="width: ${barWidth}%">
                                ${totalAllocationPercent}%
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                            <strong>${res.totalPlanned}</strong> hours planned
                        </div>
                        <div class="utilization-projects">
                            ${res.assignments.map(a => `<span title="${a.startDate} to ${a.endDate}">${a.project} (${a.allocation}%  ${a.hours}h)</span>`).join('')}
                        </div>
                    </div>
                `;
            });
            
            utilGrid.innerHTML = html || '<p style="color: #666;">No resources to display</p>';
        }
        
        function render() {
            renderTimelineHeader();
            renderUtilizationDashboard();
            populateProjectDropdown();
            populateResourceDropdown();
            
            const container = document.getElementById('projects-container');
            const { start, end } = getTimelineRange();
            const timeline = generateTimeline();
            
            let html = '';
            
            projects.forEach((proj, idx) => {
                const collapsed = proj.collapsed || false;
                const projPos = calculatePosition(proj.startDate, proj.endDate, start, end);
                const budgetStatus = getBudgetStatus(proj.effortBudget, proj.actualEffort);
                
                const isProposal = proj.type === 'Proposal';
                const chartClass = isProposal ? 'grayscale' : '';
                const statusClass = isProposal ? '' : getStatusClass(proj.health);
                
                html += `
                    <div class="project-row" data-project-index="${idx}">
                        <div class="project-info">
                            <div class="info-header">
                                <div class="info-header-top" onclick="toggleCollapse(${idx})">
                                    <div class="info-header-left">
                                        <span class="collapse-arrow">${collapsed ? '' : ''}</span>
                                        <div class="project-name">${proj.name}</div>
                                        <span class="project-type-badge type-${proj.type.toLowerCase()}">${proj.type}</span>
                                    </div>
                                    <div class="info-actions">
                                        <button class="btn-action btn-edit" onclick="event.stopPropagation(); editProject(${idx})">Edit</button>
                                        <button class="btn-action btn-delete" onclick="event.stopPropagation(); deleteProject(${idx})">Del</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-details ${collapsed ? 'collapsed' : ''}">
                                <div class="detail-row">
                                    <span class="detail-label">Client:</span>
                                    <span class="detail-value">${proj.client}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">PM:</span>
                                    <span class="detail-value">${proj.manager}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Status:</span>
                                    <span class="detail-value"><span class="status-badge status-${proj.status.toLowerCase().replace(' ', '-')}">${proj.status}</span></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Health:</span>
                                    <span class="detail-value health-${proj.health.toLowerCase().replace(' ', '-')}">${proj.health}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Budget:</span>
                                    <span class="detail-value">$${proj.budget.toLocaleString()}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Effort Budget:</span>
                                    <span class="detail-value">
                                        <span class="budget-indicator ${budgetStatus.class}">
                                            ${proj.actualEffort}h / ${proj.effortBudget}h (${budgetStatus.text})
                                        </span>
                                    </span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Dates:</span>
                                    <span class="detail-value">${proj.startDate} to ${proj.endDate}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Progress:</span>
                                    <span class="detail-value">${proj.progress}%</span>
                                </div>
                                ${proj.updates ? `
                                <div class="detail-row">
                                    <span class="detail-label">Updates:</span>
                                    <span class="detail-value">${proj.updates}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="info-resources ${collapsed ? 'collapsed' : ''}">
                                <div class="resources-header">
                                    <span class="resources-title">Resources (${proj.resources.length})</span>
                                    <button class="btn-action btn-add" onclick="addResource(${idx})">+ Add</button>
                                </div>
                                ${proj.resources.map((res, resIdx) => {
                                    const resBudgetStatus = getBudgetStatus(res.plannedHours, res.actualHours);
                                    const isOverBudget = resBudgetStatus.percent > 100;
                                    return `
                                    <div class="resource-item ${isOverBudget ? 'over-budget' : ''}">
                                        <div class="resource-name">${res.name}</div>
                                        <div class="resource-details">
                                            <span>${res.role}</span>
                                            <span>${res.allocation}% | ${res.startDate} - ${res.endDate}</span>
                                        </div>
                                        <div class="resource-budget-info ${isOverBudget ? 'over' : 'under'}">
                                            ${res.actualHours}h / ${res.plannedHours}h (${resBudgetStatus.text})
                                        </div>
                                        <div class="resource-actions">
                                            <button class="btn-action btn-edit" onclick="editResource(${idx}, ${resIdx})">Edit</button>
                                            <button class="btn-action btn-delete" onclick="deleteResource(${idx}, ${resIdx})">Del</button>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <div class="project-chart ${chartClass}">
                            <div class="chart-project">
                                <div class="chart-grid">
                                    ${timeline.map(() => '<div class="grid-cell" style="flex: 1"></div>').join('')}
                                </div>
                                <div class="chart-bar ${statusClass}" style="left: ${projPos.left}%; width: ${projPos.width}%">
                                    ${proj.name}
                                    ${!isProposal ? `<div class="progress-overlay" style="width: ${proj.progress}%"></div>` : ''}
                                </div>
                            </div>
                            
                            <div class="chart-resources">
                                ${proj.resources.map((res, resIdx) => {
                                    const resPos = calculatePosition(res.startDate, res.endDate, start, end);
                                    const roleClass = getRoleClass(res.role);
                                    const resBudgetStatus = getBudgetStatus(res.plannedHours, res.actualHours);
                                    const isOverBudget = resBudgetStatus.percent > 100;
                                    const daysPerWeek = Math.round((res.allocation / 20) * 10) / 10; // Convert % to days (100% = 5 days)
                                    return `
                                    <div class="chart-resource">
                                        <div class="chart-grid">
                                            ${timeline.map(() => '<div class="grid-cell" style="flex: 1"></div>').join('')}
                                        </div>
                                        <div class="resource-bar ${roleClass} ${isOverBudget ? 'over-budget' : ''}" style="left: ${resPos.left}%; width: ${resPos.width}%">
                                            <span class="resource-bar-label">${res.name}  ${res.plannedHours}h  ${res.allocation}%</span>
                                            <div class="resource-allocation-overlay" style="width: ${res.allocation}%"></div>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p style="text-align: center; color: #666; padding: 40px;">No projects yet. Click "Add Project" to get started.</p>';
        }
        
        function toggleCollapse(idx) {
            projects[idx].collapsed = !projects[idx].collapsed;
            saveToLocalStorage();
            render();
        }
        
        // PROJECT MODAL FUNCTIONS
        function addProject() {
            editingProject = -1;
            document.getElementById('projectForm').reset();
            document.getElementById('projType').value = 'Won';
            document.getElementById('projStatus').value = 'Active';
            document.getElementById('projHealth').value = 'On Track';
            document.getElementById('projectModal').style.display = 'block';
        }
        
        function closeProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }
        
        function editProject(idx) {
            editingProject = idx;
            const proj = projects[idx];
            document.getElementById('projName').value = proj.name;
            document.getElementById('projType').value = proj.type;
            document.getElementById('projStatus').value = proj.status;
            document.getElementById('projHealth').value = proj.health || 'On Track';
            document.getElementById('projClient').value = proj.client;
            document.getElementById('projManager').value = proj.manager;
            document.getElementById('projBudget').value = proj.budget;
            document.getElementById('projEffortBudget').value = proj.effortBudget || 0;
            document.getElementById('projActualEffort').value = proj.actualEffort || 0;
            document.getElementById('projStart').value = proj.startDate;
            document.getElementById('projEnd').value = proj.endDate;
            document.getElementById('projProgress').value = proj.progress;
            document.getElementById('projUpdates').value = proj.updates || '';
            document.getElementById('projectModal').style.display = 'block';
        }
        
        function deleteProject(idx) {
            if (confirm('Delete this project?')) {
                projects.splice(idx, 1);
                saveToLocalStorage();
                render();
            }
        }
        
        document.getElementById('projectForm').onsubmit = function(e) {
            e.preventDefault();
            
            const proj = {
                name: document.getElementById('projName').value,
                type: document.getElementById('projType').value,
                status: document.getElementById('projStatus').value,
                health: document.getElementById('projHealth').value,
                client: document.getElementById('projClient').value,
                manager: document.getElementById('projManager').value,
                budget: parseInt(document.getElementById('projBudget').value),
                effortBudget: parseInt(document.getElementById('projEffortBudget').value),
                actualEffort: parseInt(document.getElementById('projActualEffort').value) || 0,
                startDate: document.getElementById('projStart').value,
                endDate: document.getElementById('projEnd').value,
                progress: parseInt(document.getElementById('projProgress').value),
                updates: document.getElementById('projUpdates').value,
                resources: editingProject >= 0 ? projects[editingProject].resources : []
            };
            
            if (editingProject >= 0) {
                projects[editingProject] = proj;
            } else {
                projects.push(proj);
            }
            
            saveToLocalStorage();
            closeProjectModal();
            render();
        };
        
        // RESOURCE MODAL FUNCTIONS
        function addResource(projIdx) {
            editingResource = { projIdx, resIdx: -1 };
            document.getElementById('resourceForm').reset();
            document.getElementById('resourceModal').style.display = 'block';
        }
        
        function closeResourceModal() {
            document.getElementById('resourceModal').style.display = 'none';
        }
        
        function editResource(projIdx, resIdx) {
            editingResource = { projIdx, resIdx };
            const res = projects[projIdx].resources[resIdx];
            document.getElementById('resName').value = res.name;
            document.getElementById('resRole').value = res.role;
            document.getElementById('resPlannedHours').value = res.plannedHours;
            document.getElementById('resActualHours').value = res.actualHours || 0;
            document.getElementById('resAllocation').value = res.allocation;
            document.getElementById('resStart').value = res.startDate;
            document.getElementById('resEnd').value = res.endDate;
            document.getElementById('resourceModal').style.display = 'block';
        }
        
        function deleteResource(projIdx, resIdx) {
            if (confirm('Delete this resource?')) {
                projects[projIdx].resources.splice(resIdx, 1);
                saveToLocalStorage();
                render();
            }
        }
        
        document.getElementById('resourceForm').onsubmit = function(e) {
            e.preventDefault();
            
            const res = {
                name: document.getElementById('resName').value,
                role: document.getElementById('resRole').value,
                plannedHours: parseInt(document.getElementById('resPlannedHours').value),
                actualHours: parseInt(document.getElementById('resActualHours').value) || 0,
                allocation: parseInt(document.getElementById('resAllocation').value),
                startDate: document.getElementById('resStart').value,
                endDate: document.getElementById('resEnd').value
            };
            
            if (editingResource.resIdx >= 0) {
                projects[editingResource.projIdx].resources[editingResource.resIdx] = res;
            } else {
                projects[editingResource.projIdx].resources.push(res);
            }
            
            saveToLocalStorage();
            closeResourceModal();
            render();
        };
        
        // PROJECT FILTER FUNCTIONS
        function populateProjectDropdown() {
            const dropdown = document.getElementById('projectFilter');
            const currentValue = dropdown.value;
            
            // Get unique project names
            const projectNames = projects.map(p => p.name).sort();
            
            // Clear and repopulate dropdown
            dropdown.innerHTML = '<option value="">All Projects</option>';
            projectNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                dropdown.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (currentValue && projectNames.includes(currentValue)) {
                dropdown.value = currentValue;
            }
        }
        
        function filterByProject() {
            const selectedProject = document.getElementById('projectFilter').value;
            
            // Clear resource filter when project filter is applied
            if (selectedProject) {
                document.getElementById('resourceFilter').value = '';
            }
            
            // Remove all previous highlights
            document.querySelectorAll('.resource-highlight').forEach(el => {
                el.classList.remove('resource-highlight');
            });
            
            if (!selectedProject) {
                // Show all projects
                document.querySelectorAll('.project-row').forEach(row => {
                    row.style.display = 'flex';
                });
                document.querySelectorAll('.chart-resource').forEach(res => {
                    res.style.display = 'flex';
                });
                return;
            }
            
            // Filter projects
            document.querySelectorAll('.project-row').forEach((projectRow, projIdx) => {
                const proj = projects[projIdx];
                
                if (proj.name === selectedProject) {
                    projectRow.style.display = 'flex';
                } else {
                    projectRow.style.display = 'none';
                }
            });
        }
        
        // RESOURCE FILTER FUNCTIONS
        function populateResourceDropdown() {
            const dropdown = document.getElementById('resourceFilter');
            const currentValue = dropdown.value;
            
            // Get unique resource names
            const resourceNames = new Set();
            projects.forEach(proj => {
                proj.resources.forEach(res => {
                    resourceNames.add(res.name);
                });
            });
            
            // Sort alphabetically
            const sortedNames = Array.from(resourceNames).sort();
            
            // Clear and repopulate dropdown
            dropdown.innerHTML = '<option value="">All Resources</option>';
            sortedNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                dropdown.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (currentValue && sortedNames.includes(currentValue)) {
                dropdown.value = currentValue;
            }
        }
        
        function filterByResource() {
            const selectedResource = document.getElementById('resourceFilter').value;
            
            // Clear project filter when resource filter is applied
            if (selectedResource) {
                document.getElementById('projectFilter').value = '';
            }
            
            // Remove all previous highlights
            document.querySelectorAll('.resource-highlight').forEach(el => {
                el.classList.remove('resource-highlight');
            });
            
            if (!selectedResource) {
                // Show all projects and resources
                document.querySelectorAll('.project-row').forEach(row => {
                    row.style.display = 'flex';
                });
                document.querySelectorAll('.chart-resource').forEach(res => {
                    res.style.display = 'flex';
                });
                return;
            }
            
            // Filter projects and resources
            let matchCount = 0;
            document.querySelectorAll('.project-row').forEach((projectRow, projIdx) => {
                const proj = projects[projIdx];
                
                // Check if this project has the selected resource
                const hasResource = proj.resources.some(res => res.name === selectedResource);
                
                if (hasResource) {
                    projectRow.style.display = 'flex';
                    
                    // Show/hide individual resource rows within this project
                    const chartResources = projectRow.querySelectorAll('.chart-resource');
                    proj.resources.forEach((res, resIdx) => {
                        if (chartResources[resIdx]) {
                            if (res.name === selectedResource) {
                                chartResources[resIdx].style.display = 'flex';
                                chartResources[resIdx].classList.add('resource-highlight');
                                matchCount++;
                            } else {
                                chartResources[resIdx].style.display = 'none';
                            }
                        }
                    });
                } else {
                    projectRow.style.display = 'none';
                }
            });
            
            console.log(`Showing ${matchCount} assignment(s) for ${selectedResource}`);
        }
        
        function applyFilters() {
            const selectedResource = document.getElementById('resourceFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            // Clear project filter when other filters are applied
            if (selectedResource || dateFrom || dateTo) {
                document.getElementById('projectFilter').value = '';
            }
            
            // Remove all previous highlights
            document.querySelectorAll('.resource-highlight').forEach(el => {
                el.classList.remove('resource-highlight');
            });
            
            // Update utilization dashboard based on filters
            renderUtilizationDashboard();
            
            // If no filters, show everything
            if (!selectedResource && !dateFrom && !dateTo) {
                document.querySelectorAll('.project-row').forEach(row => {
                    row.style.display = 'flex';
                });
                document.querySelectorAll('.chart-resource').forEach(res => {
                    res.style.display = 'flex';
                });
                return;
            }
            
            // Apply filters to projects
            const filterStart = dateFrom ? new Date(dateFrom) : new Date('1900-01-01');
            const filterEnd = dateTo ? new Date(dateTo) : new Date('2100-12-31');
            
            let matchCount = 0;
            document.querySelectorAll('.project-row').forEach((projectRow, projIdx) => {
                const proj = projects[projIdx];
                let showProject = false;
                
                // Check each resource in the project
                const chartResources = projectRow.querySelectorAll('.chart-resource');
                proj.resources.forEach((res, resIdx) => {
                    let showResource = true;
                    
                    // Check resource name filter
                    if (selectedResource && res.name !== selectedResource) {
                        showResource = false;
                    }
                    
                    // Check date range filter
                    if (showResource && (dateFrom || dateTo)) {
                        const resStart = new Date(res.startDate);
                        const resEnd = new Date(res.endDate);
                        // Check if resource period overlaps with filter period
                        if (!(resStart <= filterEnd && resEnd >= filterStart)) {
                            showResource = false;
                        }
                    }
                    
                    // Apply visibility
                    if (chartResources[resIdx]) {
                        if (showResource) {
                            chartResources[resIdx].style.display = 'flex';
                            if (selectedResource) {
                                chartResources[resIdx].classList.add('resource-highlight');
                            }
                            showProject = true;
                            matchCount++;
                        } else {
                            chartResources[resIdx].style.display = 'none';
                        }
                    }
                });
                
                // Show/hide entire project based on whether any resources match
                projectRow.style.display = showProject ? 'flex' : 'none';
            });
            
            console.log(`Filters applied: ${matchCount} resource assignment(s) shown`);
        }
        
        function clearFilters() {
            document.getElementById('projectFilter').value = '';
            document.getElementById('resourceFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            applyFilters();
        }
        
        function exportToPDF() {
            const element = document.querySelector('.container');
            const opt = {
                margin: 10,
                filename: 'portfolio-resource-dashboard-v3.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a3', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(element).save();
        }
        
        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        };
        
        // TAB SWITCHING
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Render content based on tab
            if (tabName === 'calendar') {
                populateCalendarResources();
                renderCalendar();
            } else if (tabName === 'executive') {
                renderExecutiveDashboard();

            } else if (tabName === 'resourceforecast') {
                renderResourceForecast();
            } else if (tabName === 'resourceavailability') {
                renderResourceAvailability();
            } else if (tabName === 'riskheatmap') {
                renderRiskHeatMap();
            } else if (tabName === 'whatif') {
                populateScenarioProjectSelect();
                renderScenarios();
            }
        }
        
        // LEAVE MANAGEMENT FUNCTIONS
        function showAddLeaveModal() {
            const resourceSelect = document.getElementById('leaveResource');
            const resources = new Set();
            projects.forEach(proj => {
                proj.resources.forEach(res => resources.add(res.name));
            });
            
            resourceSelect.innerHTML = '<option value="">Select Resource</option>';
            Array.from(resources).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                resourceSelect.appendChild(option);
            });
            
            document.getElementById('leaveModal').style.display = 'block';
        }
        
        function closeLeaveModal() {
            document.getElementById('leaveModal').style.display = 'none';
            document.getElementById('leaveForm').reset();
        }
        
        document.getElementById('leaveForm').onsubmit = function(e) {
            e.preventDefault();
            const resourceName = document.getElementById('leaveResource').value;
            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            
            addResourceLeave(resourceName, startDate, endDate, leaveType);
            closeLeaveModal();
        };
        
        // EDIT RESOURCE ALLOCATION FUNCTIONS
        let currentEditResource = null;
        let currentEditProject = null;
        
        function editResourceAllocation(resourceName, projectName) {
            currentEditResource = resourceName;
            currentEditProject = projectName;
            
            // Find the project and resource
            const project = projects.find(p => p.name === projectName);
            if (!project) {
                alert('Project not found');
                return;
            }
            
            const resource = project.resources.find(r => r.name === resourceName);
            if (!resource) {
                alert('Resource not found in project');
                return;
            }
            
            // Populate modal with current values
            document.getElementById('editResourceName').textContent = resourceName;
            document.getElementById('editProjectName').textContent = projectName;
            document.getElementById('editResourceRole').textContent = resource.role;
            document.getElementById('editPlannedHours').value = resource.plannedHours;
            document.getElementById('editAllocationSlider').value = resource.allocation;
            document.getElementById('editAllocationValue').textContent = resource.allocation + '%';
            document.getElementById('editStartDate').value = resource.startDate;
            document.getElementById('editEndDate').value = resource.endDate;
            
            // Update daily hours display
            updateDailyHoursDisplay();
            
            // Show modal
            document.getElementById('editAllocationModal').style.display = 'block';
        }
        
        function closeEditAllocationModal() {
            document.getElementById('editAllocationModal').style.display = 'none';
            document.getElementById('editAllocationForm').reset();
            currentEditResource = null;
            currentEditProject = null;
        }
        
        function updateDailyHoursDisplay() {
            const allocation = document.getElementById('editAllocationSlider').value;
            const dailyHours = (allocation / 100) * 8;
            document.getElementById('editDailyHours').textContent = dailyHours.toFixed(1) + 'h';
        }
        
        // DAY-LEVEL ALLOCATION EDITING
        let currentDayEdit = null;
        
        function editDayAllocation(resourceName, projectName, date, allocation) {
            currentDayEdit = {
                resourceName: resourceName,
                projectName: projectName,
                date: date,
                allocation: allocation
            };
            
            // Find the project and resource
            const project = projects.find(p => p.name === projectName);
            if (!project) {
                alert('Project not found');
                return;
            }
            
            const resource = project.resources.find(r => r.name === resourceName);
            if (!resource) {
                alert('Resource not found in project');
                return;
            }
            
            // Format date for display
            const dateStr = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Populate modal
            document.getElementById('dayEditDate').textContent = dateStr;
            document.getElementById('dayEditResourceName').textContent = resourceName;
            document.getElementById('dayEditProjectName').textContent = projectName;
            document.getElementById('dayCurrentHours').textContent = allocation.dailyHours.toFixed(1) + 'h';
            document.getElementById('dayCurrentAllocation').textContent = resource.allocation;
            document.getElementById('dayEditAllocationSlider').value = resource.allocation;
            document.getElementById('dayEditAllocationValue').textContent = resource.allocation + '%';
            document.getElementById('dayTotalPlanned').textContent = resource.plannedHours + 'h';
            document.getElementById('dayProjectPeriod').textContent = 
                `${resource.startDate.substring(5)} to ${resource.endDate.substring(5)}`;
            
            // Update display
            updateDayAllocationDisplay();
            
            // Show modal
            document.getElementById('editDayModal').style.display = 'block';
            
            // Attach save handler NOW (when button definitely exists)
            const quickSaveBtn = document.getElementById('quickSaveBtn');
            if (quickSaveBtn) {
                quickSaveBtn.onclick = function(e) {
                    handleQuickSave();
                };
            }
        }
        
        function handleQuickSave() {
            alert('Button clicked! Check console for details.');
            console.log('=== QUICK SAVE STARTED ===');
            console.log('Quick Save clicked');
            
            if (!currentDayEdit) {
                alert('Error: No allocation selected');
                console.log('ERROR: currentDayEdit is null');
                return;
            }
            
            console.log('currentDayEdit:', currentDayEdit);
            
            const resourceName = currentDayEdit.resourceName;
            const projectName = currentDayEdit.projectName;
            const clickedDate = currentDayEdit.date;
            const newAllocation = parseInt(document.getElementById('dayEditAllocationSlider').value);
            const newDailyHours = (newAllocation / 100) * 8;
            
            // Format date as YYYY-MM-DD for storage
            const dateKey = clickedDate.toISOString().split('T')[0];
            
            console.log('Saving day-specific hours for:', dateKey);
            console.log('Resource:', resourceName, 'Project:', projectName);
            console.log('New allocation:', newAllocation + '%', 'New daily hours:', newDailyHours + 'h');
            
            const project = projects.find(p => p.name === projectName);
            if (!project) {
                alert('Error: Project not found');
                console.log('ERROR: Project not found:', projectName);
                return;
            }
            
            console.log('Found project:', project.name);
            
            const resource = project.resources.find(r => r.name === resourceName);
            
            if (!resource) {
                alert('Error: Could not find resource to update');
                console.log('ERROR: Resource not found:', resourceName);
                return;
            }
            
            console.log('Found resource:', resource.name);
            
            // Initialize dayOverrides if it doesn't exist
            if (!resource.dayOverrides) {
                resource.dayOverrides = {};
            }
            
            const oldDailyHours = resource.dayOverrides[dateKey] || ((resource.allocation / 100) * 8);
            
            console.log('Old daily hours for', dateKey + ':', oldDailyHours + 'h');
            console.log('New daily hours for', dateKey + ':', newDailyHours + 'h');
            
            // Store the day-specific hours
            resource.dayOverrides[dateKey] = newDailyHours;
            console.log('Stored dayOverride:', dateKey, '=', newDailyHours + 'h');
            
            // Save to localStorage
            console.log('Calling saveToLocalStorage()...');
            saveToLocalStorage();
            console.log('saveToLocalStorage() complete');
            
            // Close modal
            console.log('Closing modal...');
            closeEditDayModal();
            
            // Ensure resource is still selected in dropdown
            const resourceSelect = document.getElementById('calendarResourceSelect');
            if (resourceSelect) {
                console.log('Setting dropdown to:', resourceName);
                resourceSelect.value = resourceName;
                console.log('Dropdown value now:', resourceSelect.value);
            }
            
            // Force calendar refresh
            console.log('Calling renderCalendar()...');
            renderCalendar();
            console.log('renderCalendar() complete');
            
            // Show success message
            showNotification(
                ` Updated ${projectName} on ${dateKey}: ${oldDailyHours.toFixed(1)}h  ${newDailyHours.toFixed(1)}h`, 
                'success'
            );
            
            console.log('=== SAVE COMPLETE ===');
        }
        
        function closeEditDayModal() {
            document.getElementById('editDayModal').style.display = 'none';
            document.getElementById('editDayForm').reset();
            currentDayEdit = null;
        }
        
        function updateDayAllocationDisplay() {
            const allocation = document.getElementById('dayEditAllocationSlider').value;
            const dailyHours = (allocation / 100) * 8;
            document.getElementById('dayNewDailyHours').textContent = dailyHours.toFixed(1) + 'h';
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Add CSS for notification animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // RESOURCE CALENDAR FUNCTIONS
        let currentCalendarMonth = new Date();
        
        function populateCalendarResources() {
            const select = document.getElementById('calendarResourceSelect');
            const resources = new Set();
            
            projects.forEach(proj => {
                proj.resources.forEach(res => resources.add(res.name));
            });
            
            select.innerHTML = '<option value="">Select Resource</option>';
            Array.from(resources).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        function changeCalendarMonth(delta) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + delta);
            updateMonthPicker();
            renderCalendar();
        }
        
        let customDateRange = null; // Store custom date range
        
        function updateCalendarDateRange() {
            const startInput = document.getElementById('calendarStartDate');
            const endInput = document.getElementById('calendarEndDate');
            
            if (startInput && endInput && startInput.value && endInput.value) {
                const startDate = new Date(startInput.value);
                const endDate = new Date(endInput.value);
                
                if (startDate > endDate) {
                    alert('Start date must be before end date');
                    return;
                }
                
                // Store custom range
                customDateRange = {
                    start: startDate,
                    end: endDate
                };
                
                console.log('Custom date range set:', customDateRange);
                renderCalendar();
            }
        }
        
        function resetToCurrentMonth() {
            // Clear custom range
            customDateRange = null;
            
            // Reset to current month
            currentCalendarMonth = new Date();
            
            // Clear date inputs
            document.getElementById('calendarStartDate').value = '';
            document.getElementById('calendarEndDate').value = '';
            
            renderCalendar();
        }
        
        function initializeDateRangePickers() {
            // Don't pre-fill dates - let calendar start in normal month view
            // Users can select custom dates if they want
            const startInput = document.getElementById('calendarStartDate');
            const endInput = document.getElementById('calendarEndDate');
            
            if (startInput && endInput) {
                // Leave empty by default
                startInput.value = '';
                endInput.value = '';
            }
        }
        
        function populateCalendarResourceSelect() {
            const select = document.getElementById('calendarResourceSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Select Resource --</option>';
            
            // Get unique resource names from all projects
            const resourceNames = new Set();
            projects.forEach(proj => {
                if (proj.resources) {
                    proj.resources.forEach(res => {
                        if (res.name) {
                            resourceNames.add(res.name);
                        }
                    });
                }
            });
            
            // Sort and add to dropdown
            Array.from(resourceNames).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        function renderCalendar() {
            // Show resource summary when a resource is selected
            const resourceName = document.getElementById('calendarResourceSelect').value;
            
            if (resourceName) {
                showResourceSummary(resourceName);
                // Show edit hint for PM and Admin
                const hintElement = document.getElementById('pmEditHint');
                if (hintElement && (userRole === 'pm' || userRole === 'admin')) {
                    hintElement.style.display = 'block';
                }
            } else {
                document.getElementById('resourceSummarySection').style.display = 'none';
                const hintElement = document.getElementById('pmEditHint');
                if (hintElement) {
                    hintElement.style.display = 'none';
                }
            }
            
            if (!resourceName) {
                document.getElementById('calendarGrid').innerHTML = '<div style="padding: 40px; text-align: center; color: #999; grid-column: 1 / -1;">Please select a resource to view their calendar</div>';
                document.getElementById('resourceSummary').innerHTML = '';
                return;
            }
            
            let startDate, endDate, dateRangeText, daysToRender, primaryMonth;
            
            // Check if using custom date range
            if (customDateRange) {
                startDate = new Date(customDateRange.start);
                endDate = new Date(customDateRange.end);
                
                // Adjust to start on Sunday
                startDate.setDate(startDate.getDate() - startDate.getDay());
                
                // Calculate weeks needed to display the range
                const daysDiff = Math.ceil((customDateRange.end - startDate) / (1000 * 60 * 60 * 24));
                const weeksNeeded = Math.ceil(daysDiff / 7);
                daysToRender = weeksNeeded * 7;
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + daysToRender - 1);
                
                dateRangeText = `${customDateRange.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${customDateRange.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} (Custom Range)`;
                
                // Update month/year display
                document.getElementById('calendarMonthYear').textContent = `Custom Date Range`;
                
                // For custom range, we'll use the start date's month as primary
                primaryMonth = customDateRange.start.getMonth();
            } else {
                // Use current month view
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                document.getElementById('calendarMonthYear').textContent = `${monthNames[currentCalendarMonth.getMonth()]} ${currentCalendarMonth.getFullYear()}`;
                
                // Calculate calendar days for current month
                const year = currentCalendarMonth.getFullYear();
                const month = currentCalendarMonth.getMonth();
                primaryMonth = month;
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay()); // Start on Sunday
                
                // Calculate end date (6 week calendar)
                daysToRender = 42;
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 41); // Last day of 6-week calendar
                dateRangeText = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            }
            
            document.getElementById('calendarDateRange').textContent = dateRangeText;
            
            // Get resource allocations for the date range
            const allocations = getResourceAllocations(resourceName, startDate, endDate);
            
            // Render summary
            renderResourceSummary(resourceName, allocations);
            
            // Render calendar grid
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Calendar days
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < daysToRender; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(currentDate.getDate() + i);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                // For custom range, mark days outside the actual selected range as "other-month"
                if (customDateRange) {
                    if (currentDate < customDateRange.start || currentDate > customDateRange.end) {
                        dayDiv.classList.add('other-month');
                    }
                } else {
                    // For regular month view, mark days from other months
                    if (currentDate.getMonth() !== primaryMonth) {
                        dayDiv.classList.add('other-month');
                    }
                }
                
                if (currentDate.getTime() === today.getTime()) {
                    dayDiv.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                
                // Format as "MMM DD YY" (e.g., "Nov 15 25")
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthAbbr = monthNames[currentDate.getMonth()];
                const day = currentDate.getDate();
                const yearShort = String(currentDate.getFullYear()).slice(-2);
                dayNumber.textContent = `${monthAbbr} ${day} ${yearShort}`;
                
                dayDiv.appendChild(dayNumber);
                
                // Get allocations for this day
                const dayOfWeek = currentDate.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                const dayAllocations = isWeekend ? [] : allocations.filter(alloc => {
                    const start = new Date(alloc.startDate);
                    const end = new Date(alloc.endDate);
                    return currentDate >= start && currentDate <= end;
                });
                
                // Check for public holidays and resource leave
                const holiday = getAustralianHoliday(currentDate);
                const resourceLeave = getResourceLeave(resourceName, currentDate);
                
                if (holiday) {
                    const holidayDiv = document.createElement('div');
                    holidayDiv.className = 'day-allocation';
                    holidayDiv.style.background = '#E3F2FD';
                    holidayDiv.style.color = '#1976D2';
                    holidayDiv.textContent = ' Holiday';
                    holidayDiv.title = holiday;
                    dayDiv.appendChild(holidayDiv);
                } else if (resourceLeave) {
                    const leaveDiv = document.createElement('div');
                    leaveDiv.className = 'day-allocation';
                    leaveDiv.style.background = '#FFF3E0';
                    leaveDiv.style.color = '#F57C00';
                    leaveDiv.textContent = ' Leave';
                    leaveDiv.title = resourceLeave;
                    dayDiv.appendChild(leaveDiv);
                } else if (dayAllocations.length > 0 && !isWeekend) {
                    // Calculate total hours, checking for day-specific overrides
                    const dateKey = currentDate.toISOString().split('T')[0];
                    const totalHours = dayAllocations.reduce((sum, alloc) => {
                        // Check if this allocation has a day-specific override
                        const daySpecificHours = alloc.dayOverrides && alloc.dayOverrides[dateKey];
                        const hoursForDay = daySpecificHours !== undefined ? daySpecificHours : alloc.dailyHours;
                        return sum + hoursForDay;
                    }, 0);
                    
                    const allocDiv = document.createElement('div');
                    allocDiv.className = 'day-allocation' + (totalHours > 8 ? ' over' : '');
                    allocDiv.textContent = `${totalHours.toFixed(1)}h`;
                    dayDiv.appendChild(allocDiv);
                    
                    dayAllocations.forEach(alloc => {
                        // Get day-specific hours if available
                        const daySpecificHours = alloc.dayOverrides && alloc.dayOverrides[dateKey];
                        const displayHours = daySpecificHours !== undefined ? daySpecificHours : alloc.dailyHours;
                        
                        const chip = document.createElement('div');
                        chip.className = 'project-chip';
                        chip.style.background = getProjectColor(alloc.projectIndex, { type: alloc.projectType });
                        chip.textContent = alloc.projectCode;
                        chip.title = `${alloc.projectName}\n${displayHours.toFixed(1)}h`;
                        
                        // Make clickable for PM and Admin
                        if (userRole === 'pm' || userRole === 'admin') {
                            chip.style.cursor = 'pointer';
                            chip.style.transition = 'transform 0.2s, box-shadow 0.2s';
                            chip.onclick = function(e) {
                                e.stopPropagation();
                                // Pass the actual hours for this day
                                const allocWithDayHours = {...alloc, dailyHours: displayHours};
                                editDayAllocation(resourceName, alloc.projectName, currentDate, allocWithDayHours);
                            };
                            chip.onmouseover = function() {
                                this.style.transform = 'scale(1.05)';
                                this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                            };
                            chip.onmouseout = function() {
                                this.style.transform = 'scale(1)';
                                this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
                            };
                        }
                        
                        dayDiv.appendChild(chip);
                    });
                }
                
                grid.appendChild(dayDiv);
            }
        }
        
        function getResourceAllocations(resourceName, startDate, endDate) {
            console.log('getResourceAllocations called for:', resourceName);
            const allocations = [];
            
            projects.forEach((proj, index) => {
                const resource = proj.resources.find(r => r.name === resourceName);
                if (resource) {
                    const resStart = new Date(resource.startDate);
                    const resEnd = new Date(resource.endDate);
                    
                    // Check if resource period overlaps with requested period
                    if (resEnd >= startDate && resStart <= endDate) {
                        // Default: Calculate hours based on allocation %
                        // 100% = 8 hours/day, 50% = 4 hours/day, etc.
                        const defaultDailyHours = (resource.allocation / 100) * 8;
                        
                        console.log('Project:', proj.name, '- Default allocation:', resource.allocation + '%', '- Default daily hours:', defaultDailyHours + 'h');
                        
                        allocations.push({
                            project: proj.name,
                            projectName: proj.name,
                            projectCode: proj.name.substring(0, 10),
                            projectIndex: index,
                            projectType: proj.type,
                            dailyHours: defaultDailyHours,
                            hours: defaultDailyHours,
                            type: proj.type,
                            health: proj.health,
                            startDate: resource.startDate,
                            endDate: resource.endDate,
                            dayOverrides: resource.dayOverrides || {}  // Pass day overrides
                        });
                    }
                }
            });
            
            console.log('Total allocations found:', allocations.length);
            return allocations;
        }
        
        function getWorkingDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let days = 0;
            
            while (start <= end) {
                const dayOfWeek = start.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Not Sunday or Saturday
                    days++;
                }
                start.setDate(start.getDate() + 1);
            }
            
            return days;
        }
        
        function renderResourceSummary(resourceName, allocations) {
            const summary = document.getElementById('resourceSummary');
            
            // Calculate correct values from allocations
            const projectCount = allocations.length;
            
            // Calculate total daily hours (sum of all daily hours for active projects)
            const totalDailyHours = allocations.reduce((sum, alloc) => sum + (alloc.dailyHours || 0), 0);
            
            // Calculate average allocation percentage across projects
            let totalAllocationPercent = 0;
            projects.forEach(proj => {
                const resource = proj.resources.find(r => r.name === resourceName);
                if (resource) {
                    totalAllocationPercent += resource.allocation || 0;
                }
            });
            
            // Calculate total planned hours across all projects
            let totalPlanned = 0;
            projects.forEach(proj => {
                const resource = proj.resources.find(r => r.name === resourceName);
                if (resource) {
                    totalPlanned += resource.plannedHours || 0;
                }
            });
            
            summary.innerHTML = `
                <div class="summary-card">
                    <h4>Total Planned Hours</h4>
                    <div class="summary-value">${totalPlanned.toFixed(0)}h</div>
                </div>
                <div class="summary-card">
                    <h4>Active Projects</h4>
                    <div class="summary-value">${projectCount}</div>
                </div>
                <div class="summary-card">
                    <h4>Daily Average</h4>
                    <div class="summary-value">${totalDailyHours.toFixed(1)}h</div>
                </div>
            `;
        }
        
        function getProjectColor(index, project) {
            const colors = ['#7E57C2', '#26A69A', '#EF5350', '#5C6BC0', '#FFA726', '#66BB6A', '#42A5F5'];
            
            // Return grey for Proposal projects
            if (project && project.type === 'Proposal') {
                return '#CCCCCC';
            }
            
            return colors[index % colors.length];
        }
        
        function getProjectDisplayName(fullName) {
            // Extract the meaningful part after the pipe or use abbreviated form
            if (fullName.includes('|')) {
                const parts = fullName.split('|');
                const name = parts[1].trim();
                // Take first 3 words or 20 chars max
                const words = name.split(' ');
                if (words.length <= 3) return name;
                return words.slice(0, 3).join(' ');
            }
            // If no pipe, try to get client name from the format "J000XXX ClientName | Project"
            const match = fullName.match(/J\d+\s+([^|]+)/);
            if (match) {
                const name = match[1].trim();
                const words = name.split(' ');
                return words.slice(0, 2).join(' ');
            }
            // Fallback to first 20 chars
            return fullName.substring(0, 20) + (fullName.length > 20 ? '...' : '');
        }
        
        // Australian Public Holidays
        function getAustralianHoliday(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();
            
            // Fixed holidays
            if (month === 0 && day === 1) return "New Year's Day";
            if (month === 0 && day === 26) return "Australia Day";
            if (month === 3 && day === 25) return "ANZAC Day";
            if (month === 11 && day === 25) return "Christmas Day";
            if (month === 11 && day === 26) return "Boxing Day";
            
            // Easter (calculated - approximate for 2025-2026)
            const easterDates = {
                2025: { month: 3, goodFriday: 18, easterMonday: 21 },
                2026: { month: 3, goodFriday: 3, easterMonday: 6 }
            };
            
            if (easterDates[year]) {
                const easter = easterDates[year];
                if (month === easter.month && day === easter.goodFriday) return "Good Friday";
                if (month === easter.month && day === easter.goodFriday + 1) return "Easter Saturday";
                if (month === easter.month && day === easter.easterMonday) return "Easter Monday";
            }
            
            // Queen's Birthday (2nd Monday in June)
            if (month === 5 && day >= 8 && day <= 14 && date.getDay() === 1) return "Queen's Birthday";
            
            return null;
        }
        
        // Resource Leave Management
        let resourceLeave = {}; // Store as { resourceName: [{ startDate, endDate, type }] }
        
        function getResourceLeave(resourceName, date) {
            if (!resourceLeave[resourceName]) return null;
            
            for (const leave of resourceLeave[resourceName]) {
                const start = new Date(leave.startDate);
                const end = new Date(leave.endDate);
                if (date >= start && date <= end) {
                    return `${leave.type || 'Leave'}`;
                }
            }
            return null;
        }
        
        function addResourceLeave(resourceName, startDate, endDate, leaveType = 'Annual Leave') {
            if (!resourceLeave[resourceName]) {
                resourceLeave[resourceName] = [];
            }
            resourceLeave[resourceName].push({ startDate, endDate, type: leaveType });
            saveLeaveToStorage();
            renderCalendar();
        }
        
        function saveLeaveToStorage() {
            localStorage.setItem('rohling_resource_leave', JSON.stringify(resourceLeave));
        }
        
        function loadLeaveFromStorage() {
            const saved = localStorage.getItem('rohling_resource_leave');
            if (saved) {
                resourceLeave = JSON.parse(saved);
            }
        }
        
        // EXECUTIVE DASHBOARD FUNCTIONS
        function renderExecutiveDashboard() {
            renderExecutiveMetrics();
            renderCriticalRisks();
            renderActionsRequired();
            renderHealthChart();
        }
        
        function renderExecutiveMetrics() {
            const metrics = document.getElementById('execMetrics');
            
            const totalRevenue = projects.reduce((sum, proj) => sum + proj.budget, 0);
            const totalProjects = projects.length;
            const activeProjects = projects.filter(p => p.status === 'Active').length;
            const onTrack = projects.filter(p => p.health === 'On Track').length;
            const delayed = projects.filter(p => p.health === 'Delayed').length;
            const atRisk = projects.filter(p => p.health === 'At Risk').length;
            
            const totalPlannedEffort = projects.reduce((sum, proj) => sum + (proj.effortBudget || 0), 0);
            const totalActualEffort = projects.reduce((sum, proj) => sum + (proj.actualEffort || 0), 0);
            const avgProgress = projects.length > 0 ? (projects.reduce((sum, proj) => sum + proj.progress, 0) / projects.length) : 0;
            
            metrics.innerHTML = `
                <div class="exec-card success">
                    <h3>Total Portfolio Value</h3>
                    <div class="exec-value">$${(totalRevenue / 1000000).toFixed(2)}M</div>
                    <div class="exec-label">${totalProjects} Projects</div>
                </div>
                <div class="exec-card">
                    <h3>Active Projects</h3>
                    <div class="exec-value">${activeProjects}</div>
                    <div class="exec-label">${((activeProjects / totalProjects) * 100).toFixed(0)}% of portfolio</div>
                </div>
                <div class="exec-card ${onTrack > delayed + atRisk ? 'success' : 'warning'}">
                    <h3>Health Status</h3>
                    <div class="exec-value">
                        <span style="color: #66BB6A;">${onTrack}</span> /
                        <span style="color: #FFA726;">${atRisk}</span> /
                        <span style="color: #EF5350;">${delayed}</span>
                    </div>
                    <div class="exec-label">On Track / At Risk / Delayed</div>
                </div>
                <div class="exec-card ${totalActualEffort <= totalPlannedEffort ? 'success' : 'danger'}">
                    <h3>Effort Tracking</h3>
                    <div class="exec-value">${((totalActualEffort / totalPlannedEffort) * 100).toFixed(0)}%</div>
                    <div class="exec-label">${totalActualEffort}h / ${totalPlannedEffort}h</div>
                </div>
                <div class="exec-card">
                    <h3>Average Progress</h3>
                    <div class="exec-value">${avgProgress.toFixed(0)}%</div>
                    <div class="exec-label">Across all projects</div>
                </div>
            `;
        }
        
        function renderCriticalRisks() {
            const risks = document.getElementById('criticalRisks');
            const criticalProjects = [];
            
            projects.forEach(proj => {
                const variance = ((proj.actualEffort || 0) - (proj.effortBudget || 0)) / (proj.effortBudget || 1);
                if (variance > 0.1 || proj.health === 'Delayed' || proj.health === 'At Risk') {
                    criticalProjects.push({
                        name: getProjectDisplayName(proj.name),
                        fullName: proj.name,
                        issue: variance > 0.1 ? `${(variance * 100).toFixed(0)}% over budget` : proj.health,
                        severity: proj.health === 'Delayed' || variance > 0.2 ? 'critical' : ''
                    });
                }
            });
            
            if (criticalProjects.length === 0) {
                risks.innerHTML = '<li class="risk-item"> No critical risks identified</li>';
            } else {
                risks.innerHTML = criticalProjects.map(risk => 
                    `<li class="risk-item ${risk.severity}">${risk.name}<br></li>`
                ).join('');
            }
        }
        
        function renderActionsRequired() {
            const actions = document.getElementById('actionsRequired');
            const actionItems = [];
            
            projects.forEach(proj => {
                if (proj.progress === 100 && proj.status === 'Active') {
                    actionItems.push(` Close ${getProjectDisplayName(proj.name)} - ${proj.manager}`);
                }
                if ((proj.actualEffort || 0) > (proj.effortBudget || 0) * 0.9) {
                    actionItems.push(` Review budget for ${getProjectDisplayName(proj.name)}`);
                }
            });
            
            if (actionItems.length === 0) {
                actions.innerHTML = '<div class="action-item"> No immediate actions required</div>';
            } else {
                actions.innerHTML = actionItems.map(action => 
                    `<div class="action-item">${action}</div>`
                ).join('');
            }
        }
        
        function renderHealthChart() {
            const chart = document.getElementById('healthChart');
            const onTrack = projects.filter(p => p.health === 'On Track').length;
            const atRisk = projects.filter(p => p.health === 'At Risk').length;
            const delayed = projects.filter(p => p.health === 'Delayed').length;
            const total = projects.length;
            
            chart.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="flex: 1;">
                        <div style="background: #E0E0E0; height: 30px; border-radius: 15px; overflow: hidden; display: flex;">
                            <div style="background: #66BB6A; width: ${(onTrack/total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                                ${onTrack > 0 ? onTrack : ''}
                            </div>
                            <div style="background: #FFA726; width: ${(atRisk/total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                                ${atRisk > 0 ? atRisk : ''}
                            </div>
                            <div style="background: #EF5350; width: ${(delayed/total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                                ${delayed > 0 ? delayed : ''}
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        <div> ${onTrack} On Track (${((onTrack/total)*100).toFixed(0)}%)</div>
                        <div> ${atRisk} At Risk (${((atRisk/total)*100).toFixed(0)}%)</div>
                        <div> ${delayed} Delayed (${((delayed/total)*100).toFixed(0)}%)</div>
                    </div>
                </div>
            `;
        }
        
        // AI FORECASTING FUNCTIONS
        function populateAIProjectSelect() {
            const select = document.getElementById('aiProjectSelect');
            select.innerHTML = '<option value="">-- Select a Project --</option>';
            
            projects.forEach((proj, idx) => {
                if (proj.status === 'Active') {
                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = proj.name;
                    select.appendChild(option);
                }
            });
        }
        
        function renderAIForecast() {
            const projectIdx = document.getElementById('aiProjectSelect').value;
            const content = document.getElementById('aiAnalysisContent');
            
            if (!projectIdx) {
                content.innerHTML = '<div style="text-align: center; padding: 60px; color: #999;">Please select a project to see AI forecasting and recommendations</div>';
                return;
            }
            
            const proj = projects[projectIdx];
            const analysis = analyzeProjectWithAI(proj);
            
            content.innerHTML = `
                <!-- AI FORECAST CARD -->
                <div class="ai-forecast-card">
                    <h3> AI Budget Forecast for ${getProjectDisplayName(proj.name)}</h3>
                    <div class="ai-metric">
                        <div class="ai-metric-box">
                            <div class="ai-metric-label">Current Spend (AC)</div>
                            <div class="ai-metric-value">$${(analysis.currentSpend / 1000).toFixed(0)}K</div>
                            <div class="ai-metric-label" style="margin-top: 5px;">${analysis.percentComplete}% of budget</div>
                        </div>
                        <div class="ai-metric-box">
                            <div class="ai-metric-label">Burn Rate</div>
                            <div class="ai-metric-value">$${(analysis.burnRate / 1000).toFixed(0)}K/mo</div>
                            <span class="ai-trend ${analysis.burnTrend}">${analysis.burnTrendText}</span>
                        </div>
                        <div class="ai-metric-box">
                            <div class="ai-metric-label">AI Forecast (EAC)</div>
                            <div class="ai-metric-value">$${(analysis.forecastTotal / 1000).toFixed(0)}K</div>
                            <span class="ai-trend ${analysis.variance > 0 ? 'up' : 'down'}">${analysis.variance > 0 ? '+' : ''}${analysis.variance}%</span>
                        </div>
                        <div class="ai-metric-box">
                            <div class="ai-metric-label">Risk Level</div>
                            <div class="ai-metric-value">${analysis.riskLevel}</div>
                            <div class="confidence-meter">
                                <span style="font-size: 11px;">Confidence:</span>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${analysis.confidence}%"></div>
                                </div>
                                <span style="font-size: 11px; font-weight: 600;">${analysis.confidence}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- EARNED VALUE MANAGEMENT METRICS -->
                <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                    <h3 style="margin: 0 0 15px 0; color: #1976D2;"> Earned Value Management (EVM)</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                        <div style="padding: 15px; background: #E3F2FD; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Budget at Completion (BAC)</div>
                            <div style="font-size: 22px; font-weight: 700; color: #1976D2;">$${(proj.budget / 1000).toFixed(0)}K</div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">Original approved budget</div>
                        </div>
                        <div style="padding: 15px; background: #E8F5E9; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Planned Value (PV)</div>
                            <div style="font-size: 22px; font-weight: 700; color: #388E3C;">$${(analysis.plannedValue / 1000).toFixed(0)}K</div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">Should have spent by now</div>
                        </div>
                        <div style="padding: 15px; background: #FFF3E0; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Earned Value (EV)</div>
                            <div style="font-size: 22px; font-weight: 700; color: #F57C00;">$${(analysis.earnedValue / 1000).toFixed(0)}K</div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">Value of work completed</div>
                        </div>
                        <div style="padding: 15px; background: #FCE4EC; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Actual Cost (AC)</div>
                            <div style="font-size: 22px; font-weight: 700; color: #C2185B;">$${(analysis.currentSpend / 1000).toFixed(0)}K</div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">Actually spent to date</div>
                        </div>
                        <div style="padding: 15px; background: ${analysis.costVariance >= 0 ? '#E8F5E9' : '#FFEBEE'}; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Cost Variance (CV)</div>
                            <div style="font-size: 22px; font-weight: 700; color: ${analysis.costVariance >= 0 ? '#388E3C' : '#D32F2F'};">
                                ${analysis.costVariance >= 0 ? '+' : ''}$${(analysis.costVariance / 1000).toFixed(0)}K
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">EV - AC ${analysis.costVariance >= 0 ? '(Under budget )' : '(Over budget )'}</div>
                        </div>
                        <div style="padding: 15px; background: ${analysis.scheduleVariance >= 0 ? '#E8F5E9' : '#FFEBEE'}; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Schedule Variance (SV)</div>
                            <div style="font-size: 22px; font-weight: 700; color: ${analysis.scheduleVariance >= 0 ? '#388E3C' : '#D32F2F'};">
                                ${analysis.scheduleVariance >= 0 ? '+' : ''}$${(analysis.scheduleVariance / 1000).toFixed(0)}K
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">EV - PV ${analysis.scheduleVariance >= 0 ? '(Ahead )' : '(Behind )'}</div>
                        </div>
                        <div style="padding: 15px; background: ${analysis.cpi >= 1.0 ? '#E8F5E9' : '#FFEBEE'}; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Cost Performance Index (CPI)</div>
                            <div style="font-size: 22px; font-weight: 700; color: ${analysis.cpi >= 1.0 ? '#388E3C' : '#D32F2F'};">${analysis.cpi}</div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">EV  AC ${analysis.cpi >= 1.0 ? '(Efficient )' : '(Inefficient )'}</div>
                        </div>
                        <div style="padding: 15px; background: ${analysis.spi >= 1.0 ? '#E8F5E9' : '#FFEBEE'}; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Schedule Performance Index (SPI)</div>
                            <div style="font-size: 22px; font-weight: 700; color: ${analysis.spi >= 1.0 ? '#388E3C' : '#D32F2F'};">${analysis.spi}</div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">EV  PV ${analysis.spi >= 1.0 ? '(On time )' : '(Delayed )'}</div>
                        </div>
                        <div style="padding: 15px; background: #F3E5F5; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Estimate at Completion (EAC)</div>
                            <div style="font-size: 22px; font-weight: 700; color: #7B1FA2;">$${(analysis.estimateAtCompletion / 1000).toFixed(0)}K</div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">BAC  CPI (Projected total)</div>
                        </div>
                        <div style="padding: 15px; background: #E1F5FE; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Estimate to Complete (ETC)</div>
                            <div style="font-size: 22px; font-weight: 700; color: #0277BD;">$${(analysis.estimateToComplete / 1000).toFixed(0)}K</div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">EAC - AC (Cost to finish)</div>
                        </div>
                        <div style="padding: 15px; background: ${analysis.varianceAtCompletion >= 0 ? '#E8F5E9' : '#FFEBEE'}; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Variance at Completion (VAC)</div>
                            <div style="font-size: 22px; font-weight: 700; color: ${analysis.varianceAtCompletion >= 0 ? '#388E3C' : '#D32F2F'};">
                                ${analysis.varianceAtCompletion >= 0 ? '+' : ''}$${(analysis.varianceAtCompletion / 1000).toFixed(0)}K
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">BAC - EAC ${analysis.varianceAtCompletion >= 0 ? '(Surplus )' : '(Deficit )'}</div>
                        </div>
                        <div style="padding: 15px; background: #FFF9C4; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">To-Complete Performance Index (TCPI)</div>
                            <div style="font-size: 22px; font-weight: 700; color: ${analysis.tcpi <= 1.0 ? '#388E3C' : '#F57C00'};">${analysis.tcpi}</div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">(BAC-EV)  (BAC-AC) ${analysis.tcpi <= 1.0 ? '(Achievable )' : '(Challenging )'}</div>
                        </div>
                    </div>
                    
                    <!-- EVM INTERPRETATION -->
                    <div style="margin-top: 20px; padding: 15px; background: #F5F7FA; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333;"> EVM Interpretation</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px;">
                            <div>
                                <strong>Cost Performance:</strong>
                                <div style="color: ${analysis.cpi >= 1.0 ? '#388E3C' : '#D32F2F'}; margin-top: 5px;">
                                    ${analysis.cpi >= 1.0 
                                        ? ` Project is running efficiently. Getting $${analysis.cpi.toFixed(2)} of value for every $1 spent.`
                                        : ` Project is over budget. Only getting $${analysis.cpi.toFixed(2)} of value for every $1 spent.`
                                    }
                                </div>
                            </div>
                            <div>
                                <strong>Schedule Performance:</strong>
                                <div style="color: ${analysis.spi >= 1.0 ? '#388E3C' : '#D32F2F'}; margin-top: 5px;">
                                    ${analysis.spi >= 1.0
                                        ? ` Project is ${((analysis.spi - 1) * 100).toFixed(0)}% ahead of schedule.`
                                        : ` Project is ${((1 - analysis.spi) * 100).toFixed(0)}% behind schedule.`
                                    }
                                </div>
                            </div>
                            <div>
                                <strong>Completion Forecast:</strong>
                                <div style="color: ${analysis.varianceAtCompletion >= 0 ? '#388E3C' : '#D32F2F'}; margin-top: 5px;">
                                    ${analysis.varianceAtCompletion >= 0
                                        ? ` Projected to finish $${(Math.abs(analysis.varianceAtCompletion) / 1000).toFixed(0)}K under budget.`
                                        : ` Projected to exceed budget by $${(Math.abs(analysis.varianceAtCompletion) / 1000).toFixed(0)}K.`
                                    }
                                </div>
                            </div>
                            <div>
                                <strong>Remaining Work:</strong>
                                <div style="color: ${analysis.tcpi <= 1.0 ? '#388E3C' : '#F57C00'}; margin-top: 5px;">
                                    ${analysis.tcpi <= 1.0
                                        ? ` Need ${analysis.tcpi.toFixed(2)} efficiency to finish on budget (achievable).`
                                        : ` Need ${analysis.tcpi.toFixed(2)} efficiency to finish on budget (challenging).`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI RECOMMENDATIONS -->
                <h3 style="margin: 30px 0 15px 0; color: #333;"> AI-Powered Recommendations</h3>
                ${analysis.recommendations.map(rec => `
                    <div class="ai-recommendation ${rec.priority.toLowerCase()}-priority">
                        <h4>
                            ${rec.title}
                            <span class="priority-badge ${rec.priority.toLowerCase()}">${rec.priority}</span>
                        </h4>
                        <p style="color: #666; margin: 10px 0;">${rec.description}</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                            <div style="background: #F5F5F5; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #999;">Impact</div>
                                <div style="font-weight: 600; color: #333;">${rec.impact}</div>
                            </div>
                            <div style="background: #F5F5F5; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #999;">Timeline</div>
                                <div style="font-weight: 600; color: #333;">${rec.timeline}</div>
                            </div>
                            <div style="background: #F5F5F5; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #999;">Risk</div>
                                <div style="font-weight: 600; color: #333;">${rec.risk}</div>
                            </div>
                        </div>
                    </div>
                `).join('')}
                
                <!-- FORECAST TIMELINE -->
                <div class="forecast-timeline">
                    <h3 style="margin: 0 0 15px 0; color: #333;"> Budget Trend & Forecast</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 10px; background: #E8F5E9; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666;">Start Date</div>
                            <div style="font-weight: 600;">${proj.startDate}</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #E3F2FD; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666;">Current Position</div>
                            <div style="font-weight: 600;">${analysis.currentDate}</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: ${analysis.variance > 10 ? '#FFEBEE' : '#FFF3E0'}; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666;">Forecast End</div>
                            <div style="font-weight: 600;">${proj.endDate}</div>
                        </div>
                    </div>
                    <div style="padding: 20px; background: #F5F7FA; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 12px; color: #999;">Planned Budget</div>
                                <div style="font-size: 18px; font-weight: 600; color: #0052CC;">$${(proj.budget / 1000).toFixed(0)}K</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #999;">AI Forecast</div>
                                <div style="font-size: 18px; font-weight: 600; color: ${analysis.variance > 10 ? '#EF5350' : analysis.variance > 0 ? '#FFA726' : '#66BB6A'};">
                                    $${(analysis.forecastTotal / 1000).toFixed(0)}K
                                </div>
                            </div>
                        </div>
                        <div style="height: 12px; background: #E0E0E0; border-radius: 6px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, #0052CC 0%, ${analysis.variance > 10 ? '#EF5350' : '#FFA726'} 100%); width: ${(analysis.currentSpend / analysis.forecastTotal) * 100}%; transition: width 0.3s;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: #666;">
                            <span>${analysis.percentComplete}% used</span>
                            <span>${100 - analysis.percentComplete}% remaining (estimated)</span>
                        </div>
                    </div>
                </div>
                
                <!-- AI INSIGHTS -->
                <div style="margin-top: 20px; padding: 20px; background: #F0F4FF; border-radius: 12px; border-left: 4px solid #7E57C2;">
                    <h4 style="margin: 0 0 10px 0; color: #5E35B1;"> AI Insights</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #666;">
                        ${analysis.insights.map(insight => `<li style="margin-bottom: 8px;">${insight}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        function analyzeProjectWithAI(proj) {
            // Calculate project timeline
            const startDate = new Date(proj.startDate);
            const endDate = new Date(proj.endDate);
            const currentDate = new Date();
            const totalDuration = (endDate - startDate) / (1000 * 60 * 60 * 24);
            const elapsed = Math.max(0, (currentDate - startDate) / (1000 * 60 * 60 * 24));
            const percentElapsed = Math.min(100, (elapsed / totalDuration) * 100);
            
            // Calculate budget metrics
            const plannedBudget = proj.budget;
            const effortBudget = proj.effortBudget || 0;
            const actualEffort = proj.actualEffort || 0;
            const avgRate = plannedBudget / effortBudget; // $ per hour
            const currentSpend = actualEffort * avgRate;
            const percentComplete = ((actualEffort / effortBudget) * 100).toFixed(0);
            
            // Calculate burn rate (per month)
            const monthsElapsed = Math.max(1, elapsed / 30);
            const burnRate = currentSpend / monthsElapsed;
            
            // Forecast total spend using linear projection
            const monthsRemaining = Math.max(0, (endDate - currentDate) / (1000 * 60 * 60 * 24 * 30));
            const forecastTotal = currentSpend + (burnRate * monthsRemaining);
            
            // Calculate variance
            const variance = ((forecastTotal - plannedBudget) / plannedBudget * 100).toFixed(0);
            
            // Determine burn trend
            const expectedSpend = (percentElapsed / 100) * plannedBudget;
            const burnVariance = currentSpend - expectedSpend;
            let burnTrend = 'neutral';
            let burnTrendText = 'On Track';
            
            if (burnVariance > plannedBudget * 0.1) {
                burnTrend = 'up';
                burnTrendText = `${((burnVariance / plannedBudget) * 100).toFixed(0)}% Above Plan`;
            } else if (burnVariance < -plannedBudget * 0.05) {
                burnTrend = 'down';
                burnTrendText = `${((Math.abs(burnVariance) / plannedBudget) * 100).toFixed(0)}% Below Plan`;
            }
            
            // Risk assessment
            let riskLevel = 'LOW';
            let confidence = 85;
            
            if (variance > 20) {
                riskLevel = 'HIGH';
                confidence = 78;
            } else if (variance > 10) {
                riskLevel = 'MEDIUM';
                confidence = 82;
            } else if (variance > 0) {
                riskLevel = 'LOW';
                confidence = 88;
            } else {
                riskLevel = 'LOW';
                confidence = 92;
            }
            
            // Generate recommendations
            const recommendations = [];
            
            if (variance > 15) {
                recommendations.push({
                    priority: 'HIGH',
                    title: ' Negotiate Scope Reduction or Budget Increase',
                    description: `Project is forecasted to exceed budget by ${Math.abs(variance)}%. Immediate action required to either reduce scope by ~15-20% or request additional budget of $${((forecastTotal - plannedBudget) / 1000).toFixed(0)}K.`,
                    impact: `Save $${((forecastTotal - plannedBudget) * 0.5 / 1000).toFixed(0)}K`,
                    timeline: 'Within 2 weeks',
                    risk: 'Medium'
                });
            } else if (variance > 5) {
                recommendations.push({
                    priority: 'MEDIUM',
                    title: ' Review Budget and Optimize Resources',
                    description: `Trending ${variance}% over budget. Review resource allocation and consider efficiency improvements. Early intervention can bring project back on track.`,
                    impact: `Prevent $${((forecastTotal - plannedBudget) / 1000).toFixed(0)}K overrun`,
                    timeline: '2-4 weeks',
                    risk: 'Low'
                });
            }
            
            if (burnRate > (plannedBudget / (totalDuration / 30)) * 1.2) {
                recommendations.push({
                    priority: 'MEDIUM',
                    title: ' Implement Tighter Budget Controls',
                    description: `Monthly burn rate of $${(burnRate / 1000).toFixed(0)}K/month is 20%+ above plan. Implement weekly budget reviews and approval gates for additional work.`,
                    impact: 'Reduce burn 10-15%',
                    timeline: 'Immediate',
                    risk: 'Low'
                });
            }
            
            if (proj.health === 'At Risk' || proj.health === 'Delayed') {
                recommendations.push({
                    priority: 'HIGH',
                    title: ' Project Recovery Plan Needed',
                    description: `Project health is ${proj.health}. Develop recovery plan addressing timeline, resources, and deliverables. Consider bringing in project recovery specialist.`,
                    impact: 'Get back on track',
                    timeline: '1 week',
                    risk: 'Medium'
                });
            }
            
            if (recommendations.length === 0) {
                recommendations.push({
                    priority: 'LOW',
                    title: ' Continue Current Approach',
                    description: 'Project is tracking well against budget. Maintain current resource levels and monitor weekly. No immediate action required.',
                    impact: 'Stay on budget',
                    timeline: 'Ongoing',
                    risk: 'Very Low'
                });
            }
            
            // Generate insights
            const insights = [];
            
            if (percentElapsed > percentComplete) {
                insights.push(`Project is ${(percentElapsed - percentComplete).toFixed(0)}% behind schedule based on effort vs. timeline`);
            } else if (percentComplete > percentElapsed + 10) {
                insights.push(`Project is ${(percentComplete - percentElapsed).toFixed(0)}% ahead of schedule - excellent progress!`);
            }
            
            if (burnRate > 0) {
                const monthsToComplete = (effortBudget - actualEffort) / (burnRate / avgRate);
                insights.push(`At current pace, project will complete in ${monthsToComplete.toFixed(1)} months`);
            }
            
            if (variance > 0) {
                insights.push(`Budget overrun risk detected: ${variance}% over planned budget if current trend continues`);
            } else {
                insights.push(`Excellent budget management - trending ${Math.abs(variance)}% under budget`);
            }
            
            if (proj.resources.length < 3) {
                insights.push(`Small team size (${proj.resources.length} resources) - consider if more resources could accelerate delivery`);
            }
            
            // EARNED VALUE MANAGEMENT (EVM) CALCULATIONS
            // BAC = Budget at Completion (original budget)
            const BAC = plannedBudget;
            
            // PV = Planned Value (should have spent by now based on time)
            const PV = (percentElapsed / 100) * BAC;
            
            // EV = Earned Value (value of work completed)
            // Based on progress: EV = % Complete  BAC
            const progressPercent = proj.progress || ((actualEffort / effortBudget) * 100);
            const EV = (progressPercent / 100) * BAC;
            
            // AC = Actual Cost (what we've actually spent)
            const AC = currentSpend;
            
            // CV = Cost Variance (EV - AC)
            // Positive = under budget, Negative = over budget
            const CV = EV - AC;
            
            // SV = Schedule Variance (EV - PV)
            // Positive = ahead of schedule, Negative = behind schedule
            const SV = EV - PV;
            
            // CPI = Cost Performance Index (EV / AC)
            // >1.0 = under budget, <1.0 = over budget
            const CPI = AC > 0 ? EV / AC : 1.0;
            
            // SPI = Schedule Performance Index (EV / PV)
            // >1.0 = ahead of schedule, <1.0 = behind schedule
            const SPI = PV > 0 ? EV / PV : 1.0;
            
            // EAC = Estimate at Completion
            // Most common formula: EAC = BAC / CPI
            const EAC = CPI > 0 ? BAC / CPI : forecastTotal;
            
            // ETC = Estimate to Complete (how much more we need to spend)
            const ETC = EAC - AC;
            
            // VAC = Variance at Completion (BAC - EAC)
            // Positive = will finish under budget, Negative = will exceed budget
            const VAC = BAC - EAC;
            
            // TCPI = To-Complete Performance Index
            // Efficiency needed for remaining work to stay on budget
            // TCPI = (BAC - EV) / (BAC - AC)
            const TCPI = (BAC - AC) > 0 ? (BAC - EV) / (BAC - AC) : 1.0;
            
            return {
                currentSpend,
                percentComplete,
                burnRate,
                burnTrend,
                burnTrendText,
                forecastTotal,
                variance: parseInt(variance),
                riskLevel,
                confidence,
                recommendations,
                insights,
                currentDate: currentDate.toISOString().split('T')[0],
                // EVM Metrics
                plannedValue: PV,
                earnedValue: EV,
                costVariance: CV,
                scheduleVariance: SV,
                cpi: CPI.toFixed(2),
                spi: SPI.toFixed(2),
                estimateAtCompletion: EAC,
                estimateToComplete: ETC,
                varianceAtCompletion: VAC,
                tcpi: TCPI.toFixed(2)
            };
        }
        
        // RISK HEAT MAP FUNCTIONS
        function renderRiskHeatMap() {
            const grid = document.getElementById('riskHeatMapGrid');
            const details = document.getElementById('riskDetails');
            
            // Categorize projects by risk
            const riskMatrix = {
                'low-low': [],
                'low-medium': [],
                'low-high': [],
                'medium-low': [],
                'medium-medium': [],
                'medium-high': [],
                'high-low': [],
                'high-medium': [],
                'high-high': []
            };
            
            projects.forEach((proj, idx) => {
                if (proj.status !== 'Active') return;
                
                const analysis = analyzeProjectWithAI(proj);
                
                // Determine budget impact risk
                let budgetRisk = 'low';
                if (analysis.variance > 15) budgetRisk = 'high';
                else if (analysis.variance > 5) budgetRisk = 'medium';
                
                // Determine probability risk (based on health + burn rate)
                let probabilityRisk = 'low';
                if (proj.health === 'Delayed' || analysis.burnTrend === 'up') probabilityRisk = 'high';
                else if (proj.health === 'At Risk' || analysis.burnTrend === 'neutral') probabilityRisk = 'medium';
                
                const key = `${probabilityRisk}-${budgetRisk}`;
                riskMatrix[key].push({ proj, idx, analysis });
            });
            
            grid.innerHTML = `
                <div class="risk-heat-map">
                    <div></div>
                    <div class="risk-axis-label">Low Impact</div>
                    <div class="risk-axis-label">Medium Impact</div>
                    <div class="risk-axis-label">High Impact</div>
                    
                    <div class="risk-axis-label" style="writing-mode: vertical-rl; transform: rotate(180deg);">High Probability</div>
                    <div class="risk-cell high-low" onclick="showRiskDetails('high-low')">
                        ${riskMatrix['high-low'].map(r => `<span class="risk-project-chip">${getProjectDisplayName(r.proj.name)}</span>`).join('')}
                        ${riskMatrix['high-low'].length === 0 ? '<span style="color: #999; font-size: 12px;">None</span>' : ''}
                    </div>
                    <div class="risk-cell high-medium" onclick="showRiskDetails('high-medium')">
                        ${riskMatrix['high-medium'].map(r => `<span class="risk-project-chip">${getProjectDisplayName(r.proj.name)}</span>`).join('')}
                        ${riskMatrix['high-medium'].length === 0 ? '<span style="color: #999; font-size: 12px;">None</span>' : ''}
                    </div>
                    <div class="risk-cell high-high" onclick="showRiskDetails('high-high')">
                        ${riskMatrix['high-high'].map(r => `<span class="risk-project-chip">${getProjectDisplayName(r.proj.name)}</span>`).join('')}
                        ${riskMatrix['high-high'].length === 0 ? '<span style="color: #999; font-size: 12px;">None</span>' : ''}
                    </div>
                    
                    <div class="risk-axis-label" style="writing-mode: vertical-rl; transform: rotate(180deg);">Medium Probability</div>
                    <div class="risk-cell medium-low" onclick="showRiskDetails('medium-low')">
                        ${riskMatrix['medium-low'].map(r => `<span class="risk-project-chip">${getProjectDisplayName(r.proj.name)}</span>`).join('')}
                        ${riskMatrix['medium-low'].length === 0 ? '<span style="color: #999; font-size: 12px;">None</span>' : ''}
                    </div>
                    <div class="risk-cell medium-medium" onclick="showRiskDetails('medium-medium')">
                        ${riskMatrix['medium-medium'].map(r => `<span class="risk-project-chip">${getProjectDisplayName(r.proj.name)}</span>`).join('')}
                        ${riskMatrix['medium-medium'].length === 0 ? '<span style="color: #999; font-size: 12px;">None</span>' : ''}
                    </div>
                    <div class="risk-cell medium-high" onclick="showRiskDetails('medium-high')">
                        ${riskMatrix['medium-high'].map(r => `<span class="risk-project-chip">${getProjectDisplayName(r.proj.name)}</span>`).join('')}
                        ${riskMatrix['medium-high'].length === 0 ? '<span style="color: #999; font-size: 12px;">None</span>' : ''}
                    </div>
                    
                    <div class="risk-axis-label" style="writing-mode: vertical-rl; transform: rotate(180deg);">Low Probability</div>
                    <div class="risk-cell low-low" onclick="showRiskDetails('low-low')">
                        ${riskMatrix['low-low'].map(r => `<span class="risk-project-chip">${getProjectDisplayName(r.proj.name)}</span>`).join('')}
                        ${riskMatrix['low-low'].length === 0 ? '<span style="color: #999; font-size: 12px;">None</span>' : ''}
                    </div>
                    <div class="risk-cell low-medium" onclick="showRiskDetails('low-medium')">
                        ${riskMatrix['low-medium'].map(r => `<span class="risk-project-chip">${getProjectDisplayName(r.proj.name)}</span>`).join('')}
                        ${riskMatrix['low-medium'].length === 0 ? '<span style="color: #999; font-size: 12px;">None</span>' : ''}
                    </div>
                    <div class="risk-cell low-high" onclick="showRiskDetails('low-high')">
                        ${riskMatrix['low-high'].map(r => `<span class="risk-project-chip">${getProjectDisplayName(r.proj.name)}</span>`).join('')}
                        ${riskMatrix['low-high'].length === 0 ? '<span style="color: #999; font-size: 12px;">None</span>' : ''}
                    </div>
                </div>
            `;
            
            // Store matrix for details view
            window.currentRiskMatrix = riskMatrix;
            
            // Show overall summary
            const totalHigh = riskMatrix['high-high'].length + riskMatrix['high-medium'].length + riskMatrix['medium-high'].length;
            const totalMedium = riskMatrix['medium-medium'].length + riskMatrix['low-high'].length + riskMatrix['high-low'].length;
            
            details.innerHTML = `
                <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px;">
                    <h3 style="margin: 0 0 15px 0;"> Portfolio Risk Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="padding: 15px; background: ${totalHigh > 0 ? '#FFEBEE' : '#E8F5E9'}; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666;">High Risk Projects</div>
                            <div style="font-size: 28px; font-weight: 700; color: ${totalHigh > 0 ? '#EF5350' : '#66BB6A'};">${totalHigh}</div>
                        </div>
                        <div style="padding: 15px; background: #FFF3E0; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666;">Medium Risk Projects</div>
                            <div style="font-size: 28px; font-weight: 700; color: #FF9800;">${totalMedium}</div>
                        </div>
                        <div style="padding: 15px; background: #E8F5E9; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666;">Low Risk Projects</div>
                            <div style="font-size: 28px; font-weight: 700; color: #66BB6A;">${projects.length - totalHigh - totalMedium}</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 13px;">
                         Click on any cell in the heat map above to see detailed project information
                    </p>
                </div>
            `;
        }
        
        function showRiskDetails(riskKey) {
            const matrix = window.currentRiskMatrix;
            const projects = matrix[riskKey];
            
            if (projects.length === 0) {
                alert('No projects in this risk category');
                return;
            }
            
            const details = document.getElementById('riskDetails');
            const [probability, impact] = riskKey.split('-');
            
            details.innerHTML = `
                <div style="margin-top: 20px; padding: 25px; background: white; border-radius: 12px; border-left: 4px solid #FF9800;">
                    <h3 style="margin: 0 0 15px 0;"> ${probability.toUpperCase()} Probability / ${impact.toUpperCase()} Impact Projects</h3>
                    ${projects.map(p => `
                        <div style="background: #F5F7FA; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">${p.proj.name}</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 12px;">
                                <div><strong>Budget Variance:</strong> ${p.analysis.variance > 0 ? '+' : ''}${p.analysis.variance}%</div>
                                <div><strong>Health:</strong> ${p.proj.health}</div>
                                <div><strong>Burn Rate:</strong> $${(p.analysis.burnRate / 1000).toFixed(0)}K/mo</div>
                                <div><strong>Forecast:</strong> $${(p.analysis.forecastTotal / 1000).toFixed(0)}K</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // WHAT-IF SCENARIO FUNCTIONS
        function populateScenarioProjectSelect() {
            const select = document.getElementById('scenarioProjectSelect');
            select.innerHTML = '<option value="">-- Select a Project --</option>';
            
            projects.forEach((proj, idx) => {
                if (proj.status === 'Active') {
                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = proj.name;
                    select.appendChild(option);
                }
            });
        }
        
        function renderScenarios() {
            const projectIdx = document.getElementById('scenarioProjectSelect').value;
            const content = document.getElementById('scenarioContent');
            
            if (!projectIdx) {
                content.innerHTML = '<div style="text-align: center; padding: 60px; color: #999;">Please select a project to explore what-if scenarios</div>';
                return;
            }
            
            const proj = projects[projectIdx];
            const baseAnalysis = analyzeProjectWithAI(proj);
            const scenarios = generateScenarios(proj, baseAnalysis);
            
            content.innerHTML = `
                <!-- BASE CASE -->
                <div class="scenario-card" style="border-color: #757575;">
                    <h3 style="margin: 0 0 15px 0;"> Base Case: Current Plan</h3>
                    <div class="scenario-metrics">
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Total Budget</div>
                            <div class="scenario-metric-value">$${(proj.budget / 1000).toFixed(0)}K</div>
                        </div>
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Forecast</div>
                            <div class="scenario-metric-value">$${(baseAnalysis.forecastTotal / 1000).toFixed(0)}K</div>
                        </div>
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">End Date</div>
                            <div class="scenario-metric-value">${proj.endDate.split('-')[1]}/${proj.endDate.split('-')[2]}</div>
                        </div>
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Risk Level</div>
                            <div class="scenario-metric-value">${baseAnalysis.riskLevel}</div>
                        </div>
                    </div>
                </div>
                
                ${scenarios.map((scenario, idx) => `
                    <div class="scenario-card ${scenario.recommended ? 'recommended' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">${scenario.icon} ${scenario.name}</h3>
                            ${scenario.recommended ? '<span class="scenario-badge ai-recommended"> AI RECOMMENDED</span>' : ''}
                        </div>
                        <p style="color: #666; margin-bottom: 15px;">${scenario.description}</p>
                        
                        <div class="scenario-metrics">
                            <div class="scenario-metric">
                                <div class="scenario-metric-label">Budget Impact</div>
                                <div class="scenario-metric-value" style="color: ${scenario.budgetChange > 0 ? '#EF5350' : '#66BB6A'};">
                                    ${scenario.budgetChange > 0 ? '+' : ''}$${Math.abs(scenario.budgetChange / 1000).toFixed(0)}K
                                </div>
                            </div>
                            <div class="scenario-metric">
                                <div class="scenario-metric-label">Timeline Impact</div>
                                <div class="scenario-metric-value" style="color: ${scenario.timeChange > 0 ? '#EF5350' : '#66BB6A'};">
                                    ${scenario.timeChange > 0 ? '+' : ''}${scenario.timeChange} mo
                                </div>
                            </div>
                            <div class="scenario-metric">
                                <div class="scenario-metric-label">Risk Level</div>
                                <div class="scenario-metric-value">${scenario.risk}</div>
                            </div>
                            <div class="scenario-metric">
                                <div class="scenario-metric-label">AI Confidence</div>
                                <div class="scenario-metric-value">${scenario.confidence}%</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #F5F7FA; border-radius: 8px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">Key Considerations:</div>
                            <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 13px;">
                                ${scenario.considerations.map(c => `<li style="margin-bottom: 5px;">${c}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        function generateScenarios(proj, baseAnalysis) {
            const scenarios = [];
            
            // Scenario 1: Add Resources (Aggressive)
            scenarios.push({
                name: 'Scenario A: Add Resources (Aggressive)',
                icon: '',
                description: 'Bring in 2 additional contractors to accelerate delivery',
                budgetChange: proj.budget * 0.15,
                timeChange: -2,
                risk: 'LOW',
                confidence: 78,
                recommended: false,
                considerations: [
                    'Requires $' + (proj.budget * 0.15 / 1000).toFixed(0) + 'K additional budget',
                    'Team onboarding overhead of 2-3 weeks',
                    'Higher coordination complexity',
                    'Delivers 2 months earlier - better cash flow'
                ]
            });
            
            // Scenario 2: Reduce Scope (Conservative)
            scenarios.push({
                name: 'Scenario B: Reduce Scope (Conservative)',
                icon: '',
                description: 'Cut non-critical features by 15-20% to stay on budget',
                budgetChange: -proj.budget * 0.15,
                timeChange: -1,
                risk: 'MEDIUM',
                confidence: 88,
                recommended: baseAnalysis.variance > 10,
                considerations: [
                    'Saves $' + (proj.budget * 0.15 / 1000).toFixed(0) + 'K',
                    'May impact client satisfaction',
                    'Requires scope negotiation',
                    'Completes 1 month earlier'
                ]
            });
            
            // Scenario 3: Rebalance Resources (Balanced) - AI Recommended
            scenarios.push({
                name: 'Scenario C: Optimize Resources (Balanced)',
                icon: '',
                description: 'Rebalance team workload and add 1 BA for gap coverage',
                budgetChange: proj.budget * 0.05,
                timeChange: 0,
                risk: 'LOW',
                confidence: 92,
                recommended: true,
                considerations: [
                    'Minimal cost increase ($' + (proj.budget * 0.05 / 1000).toFixed(0) + 'K)',
                    'Maintains current timeline',
                    'Reduces overallocation stress',
                    'Best risk-adjusted outcome'
                ]
            });
            
            // Scenario 4: Request Budget Increase
            if (baseAnalysis.variance > 10) {
                scenarios.push({
                    name: 'Scenario D: Request Additional Budget',
                    icon: '',
                    description: 'Negotiate PCR for full forecast amount to maintain scope',
                    budgetChange: baseAnalysis.forecastTotal - proj.budget,
                    timeChange: 1,
                    risk: 'MEDIUM',
                    confidence: 75,
                    recommended: false,
                    considerations: [
                        'Requires client approval for $' + ((baseAnalysis.forecastTotal - proj.budget) / 1000).toFixed(0) + 'K',
                        'May extend timeline by 1 month for negotiation',
                        'Protects project scope',
                        'Relationship impact depends on client'
                    ]
                });
            }
            
            return scenarios;
        }
        
        // Dashboard will initialize after login via initializeDashboard()
        // No auto-initialization here
    
        // Resource Forecast - FIXED
        let forecastView = 'monthly';
        
        function setForecastView(view) {
            forecastView = view;
            document.querySelectorAll('.btn-view').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide custom date inputs
            const customDateDiv = document.getElementById('customDateRange');
            if (view === 'custom') {
                customDateDiv.style.display = 'flex';
                // Set default dates
                const today = new Date();
                const sixMonthsLater = new Date(today.getFullYear(), today.getMonth() + 6, 0);
                document.getElementById('customStartDate').value = today.toISOString().split('T')[0];
                document.getElementById('customEndDate').value = sixMonthsLater.toISOString().split('T')[0];
            } else {
                customDateDiv.style.display = 'none';
                renderResourceForecast();
            }
        }
        
        function applyCustomRange() {
            const startInput = document.getElementById('customStartDate').value;
            const endInput = document.getElementById('customEndDate').value;
            
            if (!startInput || !endInput) {
                alert('Please select both start and end dates');
                return;
            }
            
            const start = new Date(startInput);
            const end = new Date(endInput);
            
            if (end <= start) {
                alert('End date must be after start date');
                return;
            }
            
            renderResourceForecast();
        }
        
        
        function renderAIInsights() {
            const container = document.getElementById('aiInsights');
            
            // Calculate insights
            const totalProjects = projects.length;
            const activeProjects = projects.filter(p => p.status === 'Active').length;
            const atRisk = projects.filter(p => p.health === 'At Risk').length;
            const delayed = projects.filter(p => p.health === 'Delayed').length;
            
            let totalBudget = 0;
            let totalActual = 0;
            projects.forEach(p => {
                totalBudget += p.budget || 0;
                totalActual += (p.actualEffort || 0) * 250; // Assuming $250/hour
            });
            
            // Resource utilization
            const allResources = new Set();
            projects.forEach(p => {
                p.resources.forEach(r => allResources.add(r.name));
            });
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; color: white;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px;">Portfolio Health</h3>
                        <div style="font-size: 36px; font-weight: 700;">${activeProjects}/${totalProjects}</div>
                        <div style="font-size: 14px; opacity: 0.9;">Active Projects</div>
                        <div style="margin-top: 15px; font-size: 13px;">
                            <div> At Risk: ${atRisk}</div>
                            <div> Delayed: ${delayed}</div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 25px; border-radius: 12px; color: white;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px;">Budget Status</h3>
                        <div style="font-size: 36px; font-weight: 700;">$${(totalBudget/1000000).toFixed(1)}M</div>
                        <div style="font-size: 14px; opacity: 0.9;">Total Portfolio Budget</div>
                        <div style="margin-top: 15px; font-size: 13px;">
                            <div>Spent: $${(totalActual/1000000).toFixed(1)}M</div>
                            <div>Remaining: $${((totalBudget - totalActual)/1000000).toFixed(1)}M</div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 25px; border-radius: 12px; color: white;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px;">Resource Pool</h3>
                        <div style="font-size: 36px; font-weight: 700;">${allResources.size}</div>
                        <div style="font-size: 14px; opacity: 0.9;">Active Resources</div>
                        <div style="margin-top: 15px; font-size: 13px;">
                            <div>Across ${activeProjects} projects</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; padding: 25px; border-radius: 12px; border: 2px solid #E0E0E0;">
                    <h3 style="margin: 0 0 20px 0; color: #0052CC;"> AI-Powered Insights</h3>
                    <div style="display: grid; gap: 15px;">
            `;
            
            // Generate insights
            if (atRisk > 0) {
                html += `
                    <div style="padding: 15px; background: #FFF3E0; border-left: 4px solid #FF9800; border-radius: 4px;">
                        <strong> Risk Alert:</strong> ${atRisk} project${atRisk > 1 ? 's' : ''} flagged as "At Risk". Recommend immediate review and mitigation planning.
                    </div>
                `;
            }
            
            if (delayed > 0) {
                html += `
                    <div style="padding: 15px; background: #FFEBEE; border-left: 4px solid #F44336; border-radius: 4px;">
                        <strong> Schedule Alert:</strong> ${delayed} project${delayed > 1 ? 's are' : ' is'} delayed. Consider resource reallocation or scope adjustment.
                    </div>
                `;
            }
            
            const utilizationRate = Math.round((totalActual / totalBudget) * 100);
            if (utilizationRate < 50) {
                html += `
                    <div style="padding: 15px; background: #E8F5E9; border-left: 4px solid #4CAF50; border-radius: 4px;">
                        <strong> Budget Health:</strong> Portfolio is ${utilizationRate}% utilized. Good budget control maintained.
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        
        function showResourceSummary(resourceName) {
            const summarySection = document.getElementById('resourceSummarySection');
            const summaryContent = document.getElementById('resourceSummaryContent');
            
            // Find all projects this resource is assigned to
            const resourceProjects = [];
            projects.forEach(proj => {
                const resource = proj.resources.find(r => r.name === resourceName);
                if (resource) {
                    resourceProjects.push({
                        projectName: proj.name,
                        projectType: proj.type,
                        projectHealth: proj.health,
                        role: resource.role,
                        plannedHours: resource.plannedHours,
                        actualHours: resource.actualHours,
                        allocation: resource.allocation,
                        startDate: resource.startDate,
                        endDate: resource.endDate
                    });
                }
            });
            
            if (resourceProjects.length === 0) {
                summarySection.style.display = 'none';
                return;
            }
            
            summarySection.style.display = 'block';
            
            // Calculate totals
            const totalPlanned = resourceProjects.reduce((sum, p) => sum + p.plannedHours, 0);
            const totalActual = resourceProjects.reduce((sum, p) => sum + p.actualHours, 0);
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
                    <div style="padding: 10px; background: #E3F2FD; border-radius: 6px; border: 1px solid #2196F3;">
                        <div style="font-size: 11px; color: #333; margin-bottom: 3px; font-weight: 600;">Projects</div>
                        <div style="font-size: 22px; font-weight: 700; color: #0052CC;">${resourceProjects.length}</div>
                    </div>
                    <div style="padding: 10px; background: #F3E5F5; border-radius: 6px; border: 1px solid #9C27B0;">
                        <div style="font-size: 11px; color: #333; margin-bottom: 3px; font-weight: 600;">Planned</div>
                        <div style="font-size: 22px; font-weight: 700; color: #7E57C2;">${totalPlanned}h</div>
                    </div>
                    <div style="padding: 10px; background: #E8F5E9; border-radius: 6px; border: 1px solid #4CAF50;">
                        <div style="font-size: 11px; color: #333; margin-bottom: 3px; font-weight: 600;">Actual</div>
                        <div style="font-size: 22px; font-weight: 700; color: #4CAF50;">${totalActual}h</div>
                    </div>
                    <div style="padding: 10px; background: #FFF3E0; border-radius: 6px; border: 1px solid #FF9800;">
                        <div style="font-size: 11px; color: #333; margin-bottom: 3px; font-weight: 600;">Remaining</div>
                        <div style="font-size: 22px; font-weight: 700; color: #FF9800;">${totalPlanned - totalActual}h</div>
                    </div>
                </div>
                
                <h4 style="margin: 15px 0 10px 0; color: #333; font-size: 14px;">Project Assignments</h4>
                <div style="display: grid; gap: 8px;">
            `;
            
            resourceProjects.forEach((proj, idx) => {
                const healthColor = proj.projectHealth === 'On Track' ? '#4CAF50' : 
                                   proj.projectHealth === 'At Risk' ? '#FF9800' : '#F44336';
                const typeColor = proj.projectType === 'Proposal' ? '#9E9E9E' : '#0052CC';
                
                // Check if user is PM or Admin for edit permissions
                const canEdit = userRole === 'pm' || userRole === 'admin';
                
                html += `
                    <div style="padding: 12px; background: white; border-radius: 6px; border-left: 4px solid ${healthColor}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 13px; margin-bottom: 3px; color: #333;">${proj.projectName}</div>
                                <div style="font-size: 11px; color: #666;">Role: ${proj.role}</div>
                            </div>
                            <div style="display: flex; gap: 5px; flex-shrink: 0; align-items: center;">
                                <span style="padding: 2px 6px; background: ${typeColor}; color: white; border-radius: 10px; font-size: 9px;">${proj.projectType}</span>
                                <span style="padding: 2px 6px; background: ${healthColor}; color: white; border-radius: 10px; font-size: 9px;">${proj.projectHealth}</span>
                                ${canEdit ? `<button onclick="editResourceAllocation('${resourceName}', '${proj.projectName.replace(/'/g, "\\'")}')" style="padding: 4px 8px; background: #0052CC; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: 600;"> Edit</button>` : ''}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 11px; background: #F8F9FA; padding: 8px; border-radius: 4px;">
                            <div>
                                <div style="color: #666; margin-bottom: 2px;">Planned</div>
                                <div style="font-weight: 600; color: #333;">${proj.plannedHours}h</div>
                            </div>
                            <div>
                                <div style="color: #666; margin-bottom: 2px;">Actual</div>
                                <div style="font-weight: 600; color: #333;">${proj.actualHours}h</div>
                            </div>
                            <div>
                                <div style="color: #666; margin-bottom: 2px;">Allocation</div>
                                <div style="font-weight: 600; color: #333;">${proj.allocation}%</div>
                            </div>
                            <div>
                                <div style="color: #666; margin-bottom: 2px;">Period</div>
                                <div style="font-weight: 600; color: #333; font-size: 10px;">${proj.startDate.substring(5)} to ${proj.endDate.substring(5)}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            summaryContent.innerHTML = html;
        }

        
        function renderResourceAvailability() {
            const grid = document.getElementById('availabilityGrid');
            const roleFilter = document.getElementById('roleFilter').value;
            const period = document.getElementById('availabilityPeriod').value;
            
            // Determine date range based on period
            const today = new Date();
            let startDate, endDate;
            
            if (period === 'current') {
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            } else if (period === 'next') {
                startDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                endDate = new Date(today.getFullYear(), today.getMonth() + 2, 0);
            } else {
                const quarter = Math.floor(today.getMonth() / 3);
                startDate = new Date(today.getFullYear(), quarter * 3, 1);
                endDate = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
            }
            
            const periodText = `${startDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            
            // Collect all resources with their allocations
            const resourceMap = new Map();
            
            projects.forEach(proj => {
                proj.resources.forEach(res => {
                    const resStart = new Date(res.startDate);
                    const resEnd = new Date(res.endDate);
                    
                    // Check if resource is active in this period
                    if (resEnd >= startDate && resStart <= endDate) {
                        if (roleFilter && res.role !== roleFilter) return;
                        
                        if (!resourceMap.has(res.name)) {
                            resourceMap.set(res.name, {
                                name: res.name,
                                role: res.role,
                                totalAllocation: 0,
                                projects: []
                            });
                        }
                        
                        const resData = resourceMap.get(res.name);
                        resData.totalAllocation += res.allocation;
                        resData.projects.push({
                            name: proj.name,
                            allocation: res.allocation,
                            type: proj.type
                        });
                    }
                });
            });
            
            if (resourceMap.size === 0) {
                grid.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No resources found for selected filters</div>';
                return;
            }
            
            // Sort by availability (least allocated first)
            const sortedResources = Array.from(resourceMap.values()).sort((a, b) => a.totalAllocation - b.totalAllocation);
            
            let html = `<h3 style="margin: 0 0 20px 0; color: #333;">Period: ${periodText}</h3>`;
            html += '<div style="display: grid; gap: 15px;">';
            
            const roleColors = {
                'Project Manager': '#7E57C2',
                'Business Analyst': '#26A69A',
                'Tech Lead': '#EF5350',
                'Change Manager': '#FFA726',
                'Project Director': '#5C6BC0',
                'Other': '#78909C'
            };
            
            sortedResources.forEach(res => {
                const availability = Math.max(0, 100 - res.totalAllocation);
                const statusColor = availability >= 50 ? '#4CAF50' : availability >= 20 ? '#FF9800' : '#F44336';
                const statusText = availability >= 50 ? 'Available' : availability >= 20 ? 'Limited' : 'Fully Booked';
                const roleColor = roleColors[res.role] || roleColors['Other'];
                
                html += `
                    <div style="padding: 20px; background: #F5F5F5; border-radius: 8px; border-left: 6px solid ${roleColor};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <div style="font-weight: 700; font-size: 16px; margin-bottom: 5px;">${res.name}</div>
                                <div style="font-size: 13px; color: #666; padding: 3px 8px; background: ${roleColor}; color: white; border-radius: 12px; display: inline-block;">${res.role}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 32px; font-weight: 700; color: ${statusColor};">${availability}%</div>
                                <div style="font-size: 12px; color: #666;">${statusText}</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Current Allocation: ${res.totalAllocation}%</div>
                            <div style="height: 8px; background: #E0E0E0; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; background: ${statusColor}; width: ${res.totalAllocation}%;"></div>
                            </div>
                        </div>
                        
                        <div style="font-size: 12px; margin-top: 10px;">
                            <strong>Assigned to:</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                `;
                
                res.projects.forEach(proj => {
                    const projColor = proj.type === 'Proposal' ? '#9E9E9E' : '#0052CC';
                    html += `<span style="padding: 2px 8px; background: ${projColor}; color: white; border-radius: 10px; font-size: 10px;">${proj.name.substring(0, 30)}... (${proj.allocation}%)</span>`;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            grid.innerHTML = html;
        }

        function renderResourceForecast() {
            const periods = generateForecastPeriods();
            renderForecastGantt(periods);
        }
        
        function generateForecastPeriods() {
            const today = new Date();
            const periods = [];
            
            if (forecastView === 'custom') {
                const startInput = document.getElementById('customStartDate').value;
                const endInput = document.getElementById('customEndDate').value;
                
                if (startInput && endInput) {
                    const start = new Date(startInput);
                    const end = new Date(endInput);
                    
                    // Generate monthly periods between custom dates
                    let current = new Date(start.getFullYear(), start.getMonth(), 1);
                    const endMonth = new Date(end.getFullYear(), end.getMonth(), 1);
                    
                    while (current <= endMonth) {
                        const periodEnd = new Date(current.getFullYear(), current.getMonth() + 1, 0);
                        periods.push({
                            label: current.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
                            start: new Date(current),
                            end: periodEnd
                        });
                        current.setMonth(current.getMonth() + 1);
                    }
                }
                return periods;
            }
            
            if (forecastView === 'monthly') {
                for (let i = 0; i < 6; i++) {
                    const start = new Date(today.getFullYear(), today.getMonth() + i, 1);
                    const end = new Date(today.getFullYear(), today.getMonth() + i + 1, 0);
                    const monthName = start.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    periods.push({ label: monthName, start, end });
                }
            } else if (forecastView === 'quarterly') {
                const quarter = Math.floor(today.getMonth() / 3);
                for (let i = 0; i < 4; i++) {
                    const q = (quarter + i) % 4;
                    const year = today.getFullYear() + Math.floor((quarter + i) / 4);
                    const start = new Date(year, q * 3, 1);
                    const end = new Date(year, (q + 1) * 3, 0);
                    periods.push({ label: `Q${q + 1} ${year}`, start, end });
                }
            } else {
                for (let i = 0; i < 2; i++) {
                    const start = new Date(today.getFullYear(), today.getMonth() + (i * 6), 1);
                    const end = new Date(today.getFullYear(), today.getMonth() + ((i + 1) * 6), 0);
                    const label = `${start.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}`;
                    periods.push({ label, start, end });
                }
            }
            return periods;
        }
        
        function renderForecastGantt(periods) {
            const timeline = document.getElementById('ganttTimeline');
            const chart = document.getElementById('ganttChart');
            
            if (periods.length === 0) return;
            
            const startDate = periods[0].start;
            const endDate = periods[periods.length - 1].end;
            const totalRange = endDate - startDate;
            
            // DATE RANGE display
            const dateRangeText = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            
            // Timeline header
            let timelineHTML = `<div style="text-align: center; font-weight: 700; color: #0052CC; margin-bottom: 10px; font-size: 14px;"> Date Range: ${dateRangeText}</div>`;
            timelineHTML += '<div style="display: flex; border: 2px solid #0052CC; border-radius: 8px; overflow: hidden; margin-bottom: 15px;">';
            timelineHTML += '<div style="width: 300px; background: #0052CC; color: white; padding: 10px; font-weight: 700; text-align: center;">Project</div>';
            timelineHTML += '<div style="flex: 1; display: flex; background: #0052CC; color: white;">';
            periods.forEach(p => {
                timelineHTML += `<div style="flex: 1; padding: 10px; text-align: center; border-left: 1px solid #003D99; font-weight: 600; font-size: 11px;">${p.label}</div>`;
            });
            timelineHTML += '</div></div>';
            timeline.innerHTML = timelineHTML;
            
            // Gantt by PROJECT - show ALL resources
            let chartHTML = '';
            const roleColors = {
                'Project Manager': '#7E57C2',
                'Business Analyst': '#26A69A',
                'Tech Lead': '#EF5350',
                'Change Manager': '#FFA726',
                'Project Director': '#5C6BC0',
                'Other': '#78909C'
            };
            const colors = ['#7E57C2', '#26A69A', '#EF5350', '#FFA726', '#5C6BC0', '#66BB6A', '#42A5F5', '#78909C'];
            
            projects.forEach((proj, idx) => {
                const isProposal = proj.type === 'Proposal';
                
                // Check if project has resources in this period
                const hasResources = proj.resources.some(res => {
                    const resStart = new Date(res.startDate);
                    const resEnd = new Date(res.endDate);
                    return resEnd >= startDate && resStart <= endDate;
                });
                
                if (!hasResources) return;
                
                const minHeight = Math.max(60, proj.resources.length * 26 + 20);
                
                chartHTML += `<div style="display: flex; border: 2px solid #E0E0E0; border-radius: 8px; margin-bottom: 8px; background: white;">
                    <div style="width: 300px; padding: 12px; border-right: 2px solid #E0E0E0; font-weight: 600; font-size: 11px; display: flex; align-items: center;">
                        ${proj.name}
                    </div>
                    <div style="flex: 1; position: relative; padding: 8px 0; min-height: ${minHeight}px;">`;
                
                // Show ALL resources
                proj.resources.forEach((res, resIdx) => {
                    const resStart = new Date(res.startDate);
                    const resEnd = new Date(res.endDate);
                    
                    // Only show if overlaps with timeline
                    if (resEnd >= startDate && resStart <= endDate) {
                        const barStart = Math.max(0, ((resStart - startDate) / totalRange) * 100);
                        const barEnd = Math.min(100, ((resEnd - startDate) / totalRange) * 100);
                        const barWidth = barEnd - barStart;
                        
                        if (barWidth > 0) {
                            const barColor = isProposal ? '#9E9E9E' : (roleColors[res.role] || colors[idx % colors.length]);
                            const topOffset = resIdx * 26;
                            
                            chartHTML += `<div title="${res.name}: ${res.startDate} to ${res.endDate} | ${res.plannedHours}h @ ${res.allocation}%" 
                                style="position: absolute; 
                                       left: ${barStart}%; 
                                       width: ${barWidth}%; 
                                       top: ${topOffset}px;
                                       height: 22px; 
                                       background: ${barColor}; 
                                       border-radius: 4px; 
                                       color: white; 
                                       font-size: 9px; 
                                       padding: 0 6px; 
                                       display: flex; 
                                       align-items: center; 
                                       overflow: hidden; 
                                       white-space: nowrap; 
                                       box-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                                ${res.name}  ${res.plannedHours}h  ${res.allocation}%
                            </div>`;
                        }
                    }
                });
                
                chartHTML += '</div></div>';
            });
            
            if (chartHTML === '') {
                chartHTML = '<div style="padding: 40px; text-align: center; color: #999;">No resources in this time period</div>';
            }
            
            chart.innerHTML = chartHTML;
        }

    </script>
</body>
</html>
